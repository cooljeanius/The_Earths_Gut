#textdomain wesnoth-The_Earths_Gut

#define INITIALIZE_CAMPAIGN_VARIABLES
#enddef
#define CLEAR_CAMPAIGN_VARIABLES
#enddef
#define INITIALIZE_SCENARIO_VARIABLES
	{VARIABLE c_StartLoc null}
	{VARIABLE_DIFFICULTY_DEPENDANT i_Guards 4 3 2}
	{VARIABLE b_FindWayObjecticesShown false}
	{VARIABLE b_Lava true}
	{VARIABLE u_Narcatsol $null}
	{VARIABLE u_Hamel null}
	{VARIABLE u_SideOne null}
	{VARIABLE uRoFenthor null}
	{VARIABLE u_SideNine null}
	{VARIABLE c_StairsPosition.lavaX 57}
	{VARIABLE c_StairsPosition.lavaY 8}
	{VARIABLE c_StairsPosition.waterX 39}
	{VARIABLE c_StairsPosition.waterY 6}
	{VARIABLE b_SideNineAwoken no}
	{VARIABLE bNarcatsolStored no}
#enddef
#define CLEAR_SCENARIO_VARIABLES
	{CLEAR_VARIABLE c_StartLoc}
	{CLEAR_VARIABLE i_Guards}
	{CLEAR_VARIABLE b_FindWayObjecticesShown}
	{CLEAR_VARIABLE b_Lava}
	{CLEAR_VARIABLE u_Narcatsol}
	{CLEAR_VARIABLE u_Hamel}
	{CLEAR_VARIABLE u_SideOne}
	{CLEAR_VARIABLE uRoFenthor}
	{CLEAR_VARIABLE u_SideNine}
	{CLEAR_VARIABLE c_StairsPosition}
	{CLEAR_VARIABLE b_SideNineAwoken}
	{CLEAR_VARIABLE bNarcatsolStored}
#enddef

#define FOUND_WAY_OBJECTIVES X Y
	[remove_shroud]
		side=1
		x={X}
		y={Y}
		radius=2
	[/remove_shroud]
	[redraw]
		clear_shroud=yes
	[/redraw]
	[scroll_to]
		x,y={X},{Y}
	[/scroll_to]
	[delay]
		time=500
	[/delay]
	[message]
		speaker=unit
		message=_"There is a secret passage behind this wall!"
	[/message]
	[message]
		id=Hamel
		message=_"There is a trapdoor on in that keep, guarded by nasty creatures."
	[/message]
	[message]
		id=Clarissa
		message=_"We have to destroy them!"
	[/message]
	[objectives]
		side=1
		summary=_"temporary objectives:"
		[objective]
			description=_ "Defeat the trapdoor guards leader and then move Hamel to the trapdoor!"
			condition=win
		[/objective]
		{HOW_TO_LOSE_2}
		[gold_carryover]
			bonus=yes
			carryover_percentage=40
		[/gold_carryover]
	[/objectives]
	[place_shroud]
		side=1
		x={X}
		y={Y}
		radius=2
	[/place_shroud]
	[redraw]
		clear_shroud=yes
	[/redraw]
#enddef
#define OTHER_WAY_HINT X Y
	[event]
		name=moveto
		[filter]
			side=1
			x,y={X},{Y}
		[/filter]
		[message]
			speaker=unit
			message=_"There appears to have been a large cave-in at the end of this trail. I wonder what lies beyond."
		[/message]
	[/event]
#enddef
#define FIND_WAY_OBJECTIVES
	[if]
		[variable]
			name=b_FindWayObjecticesShown
			boolean_equals=false
		[/variable]
		[then]
			{VARIABLE b_FindWayObjecticesShown true}
			[message]
				id=Hamel
				message=_"We cannot cross the abyss, but we might be able to find a way around."
			[/message]
			[role_message]
				type=scout
				else_speaker=Clarissa
				message=_"We should explore every possibility."
			[/role_message]
			[objectives]
				side=1
				summary=_"temporary objectives:"
				[objective]
					description=_ "Find a way over the abyss!"
					condition=win
				[/objective]
				{HOW_TO_LOSE_2}
				[gold_carryover]
					bonus=yes
					carryover_percentage=40
				[/gold_carryover]
			[/objectives]

			[event]
				name=moveto
				[filter]
					side=1
					x = 5, 25
					y = 21, 26
				[/filter]
				[allow_undo]
				[/allow_undo]
				{TEG_EARTHQUAKE}
				[if]
					[variable]
						name=unit.x
						numerical_equals=5
					[/variable]
					# wmllint: recognize trap_guard
					[then]
						#left side hidden passage
						[terrain]
							x = 4, 5
							y = 20, 20
							terrain=Uu
						[/terrain]
						{TEG_WAKE_SIDE 3 3 16 trap_guard (Dark Sorcerer) (Necromancer) (Necromancer) (
							name=_"Do'Moran"
						) 0 0 0}
						{FOUND_WAY_OBJECTIVES 3 16}
						{OTHER_WAY_HINT 25 26}
						#{VARIABLE b_Lava true}#not neccessary, since initialized this way
					[/then]
					[else]
						#right side hidden passage
						[terrain]
							x = 26, 27
							y = 25, 26
							terrain=Uu
						[/terrain]
						{TEG_WAKE_SIDE 4 24 18 trap_guard (Dark Sorcerer) (Necromancer) (Necromancer) (
							name=_"Do'Moran"
						) 0 0 0}
						{FOUND_WAY_OBJECTIVES 24 18}
						{OTHER_WAY_HINT 5 21}
						{VARIABLE b_Lava false}
					[/else]
				[/if]
			[/event]
		[/then]
	[/if]
#enddef
#define STAIRS_HIGHLIGHTE X Y
	[message]
		id=Clarissa
		message=_"There must be a way to get out of here."
	[/message]
	[remove_shroud]
		side=1
		x={X}
		y={Y}
		radius=1
	[/remove_shroud]
	[redraw]
		clear_shroud=yes
	[/redraw]
	#Ideally it would be an upstairs, but I've found no appropriate image! Search dialogs for "ladder" when changing.
	{HIGHLIGHT_IMAGE {X} {Y} "items/ladder.png" ()}
#enddef
#define LAVA_COLOR
	{FADE_STEP_RGB 3 -3 -3 2}
	{FADE_STEP_RGB 6 -6 -6 1}
	{FADE_STEP_RGB 9 -9 -9 1}
	{FADE_STEP_RGB 10 -10 -10 1}
#enddef
#define ANTI_LAVA_COLOR
	{FADE_STEP_RGB 10 -10 -10 1}
	{FADE_STEP_RGB 9 -9 -9 1}
	{FADE_STEP_RGB 6 -6 -6 2}
	{FADE_STEP_RGB 3 -3 -3 2}
	{FADE_STEP_RGB 0 0 0 1}
#enddef
#define DESCEND FROM_X FROM_Y TO_X TO_Y
	[event]
		name=moveto
		[filter]
			id=Hamel
			x={FROM_X}
			y={FROM_Y}
		[/filter]
		[allow_undo]
		[/allow_undo]
		[sound]
			name="open-chest.wav"
		[/sound]
		[delay]
			time=100
		[/delay]
		{REMOVE_IMAGE {FROM_X} {FROM_Y}}
		{PLACE_IMAGE "items/trapdoor-open.png" {FROM_X} {FROM_Y}}
		[delay]
			time=500
		[/delay]
		{TEG_STORE_MATCHING_UNITS u_SideOne true (
			side=1
			[not]
				id=Hamel
			[/not]
			[not]
				x,y=recall,recall
			[/not]
		)}
		{TEG_STORE_MATCHING_UNITS u_Hamel true (
			id=Hamel
		)}

		[modify_side]
			side=9
			controller=null
			income=-2
		[/modify_side]
		{TELEPORT_UNITS (
			side=9
			[not]
				canrecruit=yes
			[/not]
		) 17 11 no no}
		[kill]
			side=2,3,4
		[/kill]
		[place_shroud]
			side=1
			x=1-30
			y=1-33
		[/place_shroud]
		[redraw]
			clear_shroud=yes
		[/redraw]
		[if]
			[variable]
				name=b_Lava
				boolean_equals=true
			[/variable]
			[then]
				{LAVA_COLOR}
				[time_area]
					id=lava_light
					x=32-61
					y=1-33
					{LAVA_UNDERGROUND}
				[/time_area]
			[/then]
		[/if]
		[redraw]
			clear_shroud=yes
		[/redraw]
		[delay]
			time=1000
		[/delay]
		[message]
			speaker=narrator
			image=wesnoth-icon.png
			message=_"Hamel and his group climbed down a long, deep shaft."
		[/message]
		[scroll_to]
			x={TO_X}
			y={TO_Y}
		[/scroll_to]
		[delay]
			time=1000
		[/delay]
		{TEG_UNSTORE_UNITS u_Hamel {TO_X} {TO_Y}}
		[remove_shroud]
			side=1
			x={TO_X}
			y={TO_Y}
			radius=3
		[/remove_shroud]
		[redraw]
			clear_shroud=yes
		[/redraw]
		{TEG_UNSTORE_UNITS u_SideOne {TO_X} {TO_Y}}
		[role_message]
			type=alchemist
			else_speaker=Aiglathing
			message=_"So this is the bottom of the abyss."
		[/role_message]
		[if]
			[variable]
				name=b_Lava
				boolean_equals=true
			[/variable]
			[then]
				{TEG_WAKE_SIDE 5 39 12 (drake_one) (Fire Drake) (Fire Drake) (Inferno Drake) (
					generate_name=true
				) 6 8 10}
				{TEG_WAKE_SIDE 6 54 13 (drake_two) (Drake Flare) (Drake Flare) (Drake Flameheart) (
					generate_name=true
				) 6 8 10}
				[role_message]
					type=fighter
					else_speaker=Hamel
					message=_"Looks like it is filled with lava."
				[/role_message]
				[message]
					id=Celylia
					message=_"There's an astonishing red light here...it may give lawful units an advantage if we have to fight them."
				[/message]
				{STAIRS_HIGHLIGHTE $c_StairsPosition.lavaX $c_StairsPosition.lavaY}
			[/then]
			[else]
				{TEG_WAKE_SIDE 7 37 12 (saurian_one) (Saurian Ambusher) (Saurian Flanker) (Saurian Flanker) (
					generate_name=true
				) 6 8 10}
				{TEG_WAKE_SIDE 8 50 8 (saurian_two) (Saurian Oracle) (Saurian Oracle) (Saurian Oracle) (
					generate_name=true
				) 6 8 10}
				[role_message]
					type=fighter
					else_speaker=Hamel
					message=_"Looks like it is filled with water."
				[/role_message]
				{STAIRS_HIGHLIGHTE $c_StairsPosition.waterX $c_StairsPosition.waterY}
			[/else]
		[/if]
		[objectives]
			side=1
			summary=_"temporary objectives:"
			[objective]
				description=_ "Move Hamel to the ladder!"
				condition=win
			[/objective]
			{HOW_TO_LOSE_2}
			[gold_carryover]
				bonus=yes
				carryover_percentage=40
			[/gold_carryover]
		[/objectives]
	[/event]
#enddef
#define FINAL_RECRUIT_BASE X Y
	{VARIABLE c_Keep.x {X}}
	{VARIABLE c_Keep.y {Y}}
	[terrain]
		x={X}
		y={Y}
		terrain=Ke
	[/terrain]
	{VARIABLE_OP c_Keep.x add 1}
	[terrain]
		x=$c_Keep.x
		y=$c_Keep.y
		terrain=Ce
	[/terrain]
	{VARIABLE_OP c_Keep.y add 1}
	[terrain]
		x=$c_Keep.x
		y=$c_Keep.y
		terrain=Ce
	[/terrain]
	{CLEAR_VARIABLE c_Keep}
#enddef
#define WAKEUP_SIDE_NINE
	[if]
		[not]
			[have_unit]
				id=RoFenthor
			[/have_unit]
		[/not]
		[then]
			[unit]
				side=9
				type=Lich
				canrecruit=yes
				id=RoFenthor
				name=_"Ro'Fenthor"
				unrenamable=yes
				x,y=17,11
			[/unit]
			[modify_side]
				side=9
				{QUANTITY income 10 14 20}
			[/modify_side]
		[/then]
	[/if]
#enddef
#define FINAL_WAKEUP_SIDE_NINE
	[modify_side]
		side=9
		controller=ai
	[/modify_side]
	{WAKEUP_SIDE_NINE}
	[modify_side]
		side=9
		{QUANTITY income 20 24 30}
		[ai]
			#Tell the ai not to capture the player's villages on the other side since he can't move there.
			[avoid]
				x = 2, 5, 8, 16, 23, 25
				y = 24, 16, 27, 26, 20, 32
			[/avoid]
			recruitment_pattern=fighter,archer,scout
		[/ai]
		recruit=Wraith,Revenant,Bone Shooter
	[/modify_side]
	[gold]
		side=9
		{QUANTITY amount 160 180 210}
	[/gold]
#enddef
#define ASCEND TO_X TO_Y
	[delay]
		time=300
	[/delay]
	{TEG_STORE_MATCHING_UNITS u_SideOne true (
		side=1
		[not]
			id=Hamel
		[/not]
		[not]
			x,y=recall,recall
		[/not]
	)}
	{TEG_STORE_MATCHING_UNITS u_Hamel true (
		id=Hamel
	)}
	{TEG_KILL_SIDE 5}
	{TEG_KILL_SIDE 6}
	{TEG_KILL_SIDE 7}
	{TEG_KILL_SIDE 8}
	[place_shroud]
		side=1
		x=32-61
		y=1-33
	[/place_shroud]
	[redraw]
		clear_shroud=yes
	[/redraw]
	{ANTI_LAVA_COLOR}
	[time_area]
		id=lava_light
		remove=yes
	[/time_area]
	[redraw]
		clear_shroud=yes
	[/redraw]
	{FINAL_RECRUIT_BASE {TO_X} {TO_Y}}
	[delay]
		time=1000
	[/delay]
	[message]
		speaker=narrator
		image=wesnoth-icon.png
		message=_"The group traveled up a winding path of crudely carved stairs for what seemed like hours. Finally, they came to wide open caverns..."
	[/message]
	[scroll_to]
		x={TO_X}
		y={TO_Y}
	[/scroll_to]
	[delay]
		time=1000
	[/delay]
	{TEG_UNSTORE_UNITS u_Hamel {TO_X} {TO_Y}}
	[remove_shroud]
		side=1
		x={TO_X}
		y={TO_Y}
		radius=3
	[/remove_shroud]
	[redraw]
		clear_shroud=yes
	[/redraw]
	{TEG_UNSTORE_UNITS u_SideOne {TO_X} {TO_Y}}
	{FINAL_WAKEUP_SIDE_NINE}
	[role_message]
		type=guard
		else_speaker=Aiglathing
		message=_"We have made it through!"
	[/role_message]
	[message]
		id=Clarissa
		message=_"I sense the presence of a great evil, perhaps a powerful necromancer. Finally, a challenge!"
	[/message]
	# wmllint: local spelling Ro'Fenthor
	[objectives]
		side=1
		summary=_"final objectives:"
		[objective]
			description=_ "Defeat Ro'Fenthor!"
			condition=win
		[/objective]
		{HOW_TO_LOSE_2}
		[gold_carryover]
			bonus=yes
			carryover_percentage=40
		[/gold_carryover]
	[/objectives]
#enddef

[scenario]
	id=07_The_bridge_is_broken
	next_scenario=08_Lost
	name= _ "The bridge is broken"
	map_data={TEG_MAP 07_The_bridge_is_broken.map}
	snapshot=false

	victory_when_enemies_defeated=false

	{UNDERGROUND}
	{TURNS 44 40 36}

	{MOOD_EPIC}

	[story]
		[part]
			story= _ "Leaving their elvish allies behind, the group explored deep into the caves, following a wide carved path of dwarven design..."
		[/part]
	[/story]
	{TRAVELMAP_THE_BRIDGE_IS_BROKEN}

	[side]
		#the player
		side=1
		controller=human
		type=Advanced Dwarvish Fighter
		id=Hamel
		name= _ "Hamel"
		canrecruit=yes
		persistent=true
		save_id=human_player
		shroud=true
#ifdef HARD
		recruit=Dwarvish Fighter,Dwarvish Thunderer,Dwarvish Scout
#else
		recruit=Dwarvish Fighter,Dwarvish Thunderer,Alchemist,Dwarvish Scout
#endif
		team_name=dwarves
		{FLAG_VARIANT knalgan}
		{GOLD 140 120 100}
	[/side]
	[side]
		#goblins in start keep
		side=2
		controller=ai
#ifdef HARD
		type=Orcish Grunt
#else
		type=Goblin Rouser
#endif
		id=Bagdish
		name= _ "Bagdish"
		canrecruit=yes
#ifdef EASY
		recruit=Goblin Spearman
#endif
#ifdef NORMAL
		recruit=Goblin Impaler,Goblin Spearman
#endif
#ifdef HARD
		recruit=Goblin Rouser,Goblin Impaler,Goblin Spearman
#endif
		team_name=cave_occupants
		hidden=true
		[ai]
			passive_leader=yes
			aggression=1.0
		[/ai]
		{GOLD 40 50 70}
	[/side]
	{TEG_LIMIT_CONTEMPORANEOUS_RECRUITS_DIFFICULTY_DEPENDANT 2 (Goblin Impaler) 0 1 2}
	{TEG_LIMIT_CONTEMPORANEOUS_RECRUITS_DIFFICULTY_DEPENDANT 2 (Goblin Rouser) 0 0 1}
	[side]
		#trapdoor guard on left side
		side=3
		controller=ai
		no_leader=yes
#ifdef EASY
		recruit=Skeleton,Skeleton Archer,Ghoul,Vampire Bat
#endif
#ifdef NORMAL
		recruit=Skeleton,Skeleton Archer,Chocobone,Ghoul,Vampire Bat,Blood Bat
#endif
#ifdef HARD
		recruit=Skeleton,Skeleton Archer,Chocobone,Ghoul,Vampire Bat,Blood Bat,Dread Bat
#endif
		team_name=cave_occupants
		hidden=true
		[ai]
			recruitment_ignore_bad_movement=true
			aggression=0.8
			caution=0.5
			recruitment_pattern=fighter,archer,scout,scout
		[/ai]
		{GOLD 120 140 190}
		{INCOME -2 -2 -2}
	[/side]
	{TEG_LIMIT_CONTEMPORANEOUS_RECRUITS_DIFFICULTY_DEPENDANT 3 Chocobone 0 1 1}
	{TEG_LIMIT_CONTEMPORANEOUS_RECRUITS_DIFFICULTY_DEPENDANT 3 (Blood Bat) 0 1 1}
	{TEG_LIMIT_CONTEMPORANEOUS_RECRUITS_DIFFICULTY_DEPENDANT 3 (Dread Bat) 0 0 1}
	#Skeleton,Ghost,Revenant,Skeleton Archer,Bone Shooter,Dark Adept,Ghoul,Chocobone,Wraith
	#(Vampire Bat,Blood Bat,Ghost) (Vampire Bat,Blood Bat,Ghost,Dread Bat) (Blood Bat,Ghost,Dread Bat,Wraith)
	[side]
		#trapdoor guard on right side
		side=4
		controller=ai
		no_leader=yes
#ifdef EASY
		recruit=Skeleton,Skeleton Archer,Dark Adept,Ghost
#endif
#ifdef NORMAL
		recruit=Skeleton,Skeleton Archer,Dark Adept,Ghost,Wraith
#endif
#ifdef HARD
		recruit=Skeleton,Skeleton Archer,Dark Adept,Ghost,Wraith
#endif
		team_name=cave_occupants
		hidden=true
		[ai]
			recruitment_ignore_bad_movement=true
			aggression=0.8
			caution=0.5
			recruitment_pattern=fighter,archer,scout,scout
		[/ai]
		{GOLD 120 140 190}
		{INCOME -2 -2 -2}
	[/side]
	{TEG_LIMIT_CONTEMPORANEOUS_RECRUITS_DIFFICULTY_DEPENDANT 4 Wraith 0 1 2}
	[side]
		side=5
		controller=ai
		no_leader=yes
		#available drake units
		#Drake Fighter,Drake Warrior,Drake Blademaster,Drake Burner,Fire Drake,Drake Flare,Inferno Drake,Drake Flameheart,Drake Clasher,Drake Thrasher,Drake Arbiter,Drake Enforcer,Drake Warden,Drake Glider,Sky Drake,Hurricane Drake
#ifdef EASY
		recruit=Drake Glider,Drake Clasher
#endif
#ifdef NORMAL
		recruit=Drake Fighter,Drake Glider,Drake Clasher
#endif
#ifdef HARD
		recruit=Drake Fighter,Drake Glider,Drake Clasher,Drake Warrior,Drake Thrasher,Sky Drake
#endif
		team_name=cave_occupants
		hidden=true
		[ai]
			recruitment_ignore_bad_movement=true
			passive_leader=yes
		[/ai]
		{GOLD 80 110 150}
		{INCOME -2 -2 -2}
	[/side]
#ifdef HARD
	{LIMIT_CONTEMPORANEOUS_RECRUITS 5 (Drake Warrior) 1}
	{LIMIT_CONTEMPORANEOUS_RECRUITS 5 (Drake Thrasher) 1}
	{LIMIT_CONTEMPORANEOUS_RECRUITS 5 (Sky Drake) 1}
#endif
	[side]
		side=6
		controller=ai
		no_leader=yes
#ifdef EASY
		recruit=Drake Fighter,Drake Clasher
#endif
#ifdef NORMAL
		recruit=Drake Fighter,Drake Clasher,Drake Burner
#endif
#ifdef HARD
		recruit=Drake Fighter,Drake Clasher,Drake Burner,Drake Warrior,Fire Drake,Drake Thrasher
#endif
		team_name=cave_occupants
		hidden=true
		[ai]
			recruitment_ignore_bad_movement=true
			passive_leader=yes
		[/ai]
		{GOLD 80 110 150}
		{INCOME -2 -2 -2}
	[/side]
#ifdef HARD
	{LIMIT_CONTEMPORANEOUS_RECRUITS 6 (Drake Warrior) 1}
	{LIMIT_CONTEMPORANEOUS_RECRUITS 6 (Drake Thrasher) 1}
	{LIMIT_CONTEMPORANEOUS_RECRUITS 6 (Fire Drake) 1}
#endif
	[side]
		side=7
		controller=ai
		no_leader=yes
		#available saurian units
		#Saurian Skirmisher,Saurian Ambusher,Saurian Flanker,Saurian Augur,Saurian Oracle,Saurian Soothsayer
#ifdef EASY
		recruit=Saurian Skirmisher
#endif
#ifdef NORMAL
		recruit=Saurian Skirmisher,Saurian Augur
#endif
#ifdef HARD
		recruit=Saurian Skirmisher,Saurian Augur,Saurian Flanker
#endif
		team_name=cave_occupants
		hidden=true
		[ai]
			recruitment_ignore_bad_movement=true
		[/ai]
		{GOLD 80 110 150}
		{INCOME -2 -2 -2}
	[/side]
#ifdef HARD
	{LIMIT_CONTEMPORANEOUS_RECRUITS 7 (Saurian Flanker) 2}
#endif
	[side]
		side=8
		controller=ai
		no_leader=yes
		#available saurian units
		#Saurian Skirmisher,Saurian Ambusher,Saurian Flanker,Saurian Augur,Saurian Oracle,Saurian Soothsayer
#ifdef EASY
		recruit=Saurian Augur
#endif
#ifdef NORMAL
		recruit=Saurian Skirmisher,Saurian Augur
#endif
#ifdef HARD
		recruit=Saurian Skirmisher,Saurian Augur,Saurian Oracle,Saurian Soothsayer
#endif
		team_name=cave_occupants
		hidden=true
		[ai]
			recruitment_ignore_bad_movement=true
		[/ai]
		{GOLD 80 110 150}
		{INCOME -2 -2 -2}
	[/side]
#ifdef HARD
	{LIMIT_CONTEMPORANEOUS_RECRUITS 8 (Saurian Oracle) 1}
	{LIMIT_CONTEMPORANEOUS_RECRUITS 8 (Saurian Soothsayer) 1}
#endif
	[side]
		side=9
		controller=ai
		no_leader=yes
		#only flying units here, since others can't reach the player
#ifdef EASY
		recruit=Vampire Bat,Ghost
#endif
#ifdef NORMAL
		recruit=Blood Bat,Ghost
#endif
#ifdef HARD
		recruit=Blood Bat,Ghost,Dread Bat,Wraith
#endif
		team_name=cave_occupants
		hidden=true
		[ai]
			recruitment_ignore_bad_movement=yes
			recruitment_ignore_bad_combat=yes
			passive_leader=yes
		[/ai]
		{GOLD 80 100 130}
		{INCOME -2 -2 -2}
	[/side]
#ifdef EASY
	{LIMIT_CONTEMPORANEOUS_RECRUITS 9 (Ghost) 2}
#endif
#ifdef NORMAL
	{LIMIT_CONTEMPORANEOUS_RECRUITS 9 (Blood Bat) 1}
#endif
#ifdef HARD
	{LIMIT_CONTEMPORANEOUS_RECRUITS 9 (Blood Bat) 1}
	{LIMIT_CONTEMPORANEOUS_RECRUITS 9 (Dread Bat) 1}
#endif

	{SETUP_LUA}
	{SAVEFILE_COMPATIBILITY}
	[event]
		name=prestart
		[objectives]
			side=1
			summary=_"starting objectives:"
			[objective]
				description=_ "Explore and conquer a recruit base!"
				condition=win
			[/objective]
			{HOW_TO_LOSE_2}
			[gold_carryover]
				bonus=yes
				carryover_percentage=40
			[/gold_carryover]
		[/objectives]
		{INITIALIZE_CAMPAIGN_VARIABLES}
		{INITIALIZE_SCENARIO_VARIABLES}

		{PLACE_IMAGE "items/chest-plain-closed.png" 17 29}
		{PLACE_IMAGE "items/trapdoor-closed.png" 3 15}
		{PLACE_IMAGE "items/trapdoor-closed.png" 25 18}

		{PLACE_IMAGE "items/ladder.png" $c_StairsPosition.lavaX $c_StairsPosition.lavaY}

		{LOYAL_UNDEAD_UNIT 3 Revenant 3 18} {GUARDIAN}
		{LOYAL_UNDEAD_UNIT 3 (Bone Shooter) 5 17} {GUARDIAN}
		{LOYAL_UNDEAD_UNIT 3 Revenant 4 17} {GUARDIAN}

		{LOYAL_UNDEAD_UNIT 4 Revenant 24 22} {GUARDIAN}
		{LOYAL_UNDEAD_UNIT 4 (Bone Shooter) 25 22} {GUARDIAN}
		{LOYAL_UNDEAD_UNIT 4 Revenant 26 21} {GUARDIAN}

		{RECALL_LOYAL_UNITS}
	[/event]

	[event]
		name=start
		# wmllint: recognize Aiglathing
		# wmllint: recognize Clarissa
		# wmllint: recognize Celylia
		[store_starting_location]
			side=1
			variable=c_StartLoc
		[/store_starting_location]
		#give some extra units
		# wmllint: recognize help_fighter
		{UNIT 1 (Dwarvish Fighter) $c_StartLoc.x $c_StartLoc.y (
			generate_name=true
			id=help_fighter
			animate=true
			[modifications]
				{TRAIT_HEALTHY}
				{TRAIT_STRONG}
			[/modifications]
		)}
		# wmllint: recognize help_guardsman
		{UNIT 1 (Dwarvish Guardsman) $c_StartLoc.x $c_StartLoc.y (
			generate_name=true
			id=help_guardsman
			animate=true
			[modifications]
				{TRAIT_HEALTHY}
				{TRAIT_RESILIENT}
			[/modifications]
		)}
		[if]
			[have_unit]
				id=Clarissa
			[/have_unit]
			[then]
				#good for you - do nothing
			[/then]
			[else]
				#give extra unit
				# wmllint: recognize replace_thunderer
				{UNIT 1 (Dwarvish Thunderer) $c_StartLoc.x $c_StartLoc.y (
					generate_name=true
					id=replace_thunderer
					animate=true
					[modifications]
						{TRAIT_LOYAL}
						{TRAIT_HEALTHY}
						{TRAIT_RESILIENT}
					[/modifications]
					{IS_LOYAL}
				)}
			[/else]
		[/if]
		[message]
			id=help_guardsman
			message=_"My lord, why do we continue to go deeper into these evil caves, and risk ourselves to battle what lurks here?"
		[/message]
		[message]
			id=Hamel
			message=_"Why do you ask? Do you fear these caves?"
		[/message]
		[message]
			id=help_guardsman
			message=_"The elven leader said that there was a great evil awaken down here, by our kinsmen who came here first. Suppose..."
		[/message]
		[message]
			id=Aiglathing
			message=_"Suppose that this evil was too great for them, and perhaps us as well? Do you suggest we are not able to overcome them?"
		[/message]
		[message]
			id=help_guardsman
			message=_"I am no coward, but I am not a fool either."
		[/message]
		[message]
			id=Celylia
			message=_"All I know from my people is there was some terrible thing which happened down here in these caverns. The dwarves were digging deep... too deep."
		[/message]
		[message]
			id=Hamel
			message=_"Perhaps. Whatever my kinsmen faced, I'm sure they did their best to defeat it before ever turning to flee."
		[/message]
		[message]
			id=Celylia
			message=_"I agree. Indeed, from what I know of the stubbornness of dwarves, it must have taken something quite spectacular to cause them to abandon their mines and flee in terror."
		[/message]
		[message]
			id=help_fighter
			message=_"How dare youâ€¦"
		[/message]
		[message]
			id=Hamel
			message=_"Enough of this! We move forward now! Onwards, to conquer what is ours!"
		[/message]
		#Either Clarissa is there, or replace_thunderer - neither both, nor none.
		[message]
			id=Clarissa
			message=_"Well spoken. Certainly no force is unconquerable, so long as we fight together."
		[/message]
		[if]
			[have_unit]
				id=replace_thunderer
			[/have_unit]
			[then]
				[message]
					id=replace_thunderer
					message=_"Aye, lord! These caves will be ours!"
				[/message]
			[/then]
		[/if]
		[message]
			id=Celylia
			message=_"I hope we meet better fortune than those that went before. As I remember it told, the dwarves who fled the caves were so driven mad by what they had found, that they were nearly unable to talk. What's more, they made themselves such a nuisance that we were forced to drive them away."
		[/message]
		[message]
			id=Hamel
			message=_"We will be more careful than our kinsmen, elf. We know some of what lies ahead, and what benefits await us in the deeper ore veins, should we succeed to recapture them."
		[/message]

		[if]
			# wmllint: recognize Narcatsol
			[have_unit]
				id=Narcatsol
				search_recall_list=yes
			[/have_unit]
			[then]
				[recall]
					id=Narcatsol
				[/recall]
				[message]
					id=Narcatsol
					message=_"My lord, I'm afraid my beast refuses to travel in these caverns. Perhaps the ceiling is too close for flying."
				[/message]
				[message]
					id=Narcatsol
					message=_"You can rely on me again once we are in higher caverns."
				[/message]
				{VARIABLE bNarcatsolStored yes}
				[store_unit]
					variable=u_Narcatsol
					[filter]
						id=Narcatsol
					[/filter]
					kill=true
				[/store_unit]
			[/then]
		[/if]
	[/event]

	{SET_SCENARIO_STATUS_TO (
		[option]
			message=_"to just before descending."
			[command]
				[kill]
					side=2,3,4
				[/kill]
				{TELEPORT_UNITS side=1 5 17 yes no}
				[scroll_to_unit]
					side=1
				[/scroll_to_unit]
				{DESCEND 3 15 40 21}
			[/command]
		[/option]
		[option]
			message=_"to after the ascension to the other side."
			[command]
				[kill]
					side=2,3,4,5,6,7,8
				[/kill]
				{TELEPORT_UNITS (
					side=1
				) 13 8 yes no}
				{FINAL_WAKEUP_SIDE_NINE}
			[/command]
		[/option]
	)}

	[event]
		name=moveto
		[filter]
			id=Celylia
			[filter_location]
				terrain=Uu^Uf
			[/filter_location]
		[/filter]
		[allow_undo]
		[/allow_undo]
		[message]
			id=Celylia
			message=_"Such tall mushrooms! They remind me of the young trees in the forest..."
		[/message]
	[/event]

	[event]
		name=last breath
		[filter]
			id=Bagdish
		[/filter]
		[if]
			[variable]
				name=b_SideNineAwoken
				boolean_equals=no
			[/variable]
			[then]
				{VARIABLE b_SideNineAwoken yes}
				# wmllint: recognize RoFenthor
				{WAKEUP_SIDE_NINE}
			[/then]
		[/if]
	[/event]
	[event]
		name=moveto
		[filter]
			side=1
			x,y=17,29
		[/filter]
		[allow_undo]
		[/allow_undo]
		[message]
			speaker=unit
			message=_"Well now, it seems our small foe has left us some valuables..."
		[/message]
		[sound]
			name="open-chest.wav"
		[/sound]
		{REMOVE_IMAGE 17 29}
		{PLACE_IMAGE "items/chest-plain-open.png" 17 29}
		[if]
			[variable]
				name=unit.race
				equals="dwarf"
			[/variable]
			[then]
				[message]
					speaker=unit
					message=_"This chest is full of ore! Fine quality, too!"
				[/message]
			[/then]
			[else]
				[message]
					speaker=unit
					message=_"This chest is full of ore! Although I don't know enough about mining to make a precise guess about the quality..."
				[/message]
				[message]
					id=Aiglathing
					message=_"Since it is from here, it is fine quality for sure."
				[/message]
			[/else]
		[/if]
		[message]
			id=Hamel
			message=_"Excellent. Perhaps we may hope to find even finer metal soon. We will use this to equip some of the men as guardsmen. A pity we do not have more of this."
		[/message]
		[message]
			speaker=narrator
			image="wesnoth-icon.png"
			message=_"Hint: You may now recruit up to $i_Guards| Dwarvish Guardsmen!"
		[/message]
		[allow_recruit]
			type=Dwarvish Guardsman
			side=1
		[/allow_recruit]
	[/event]

	#event to limit the recruits of Dwarvish Guardsmen
	[event]
		name=recruit
		first_time_only=false
		[filter]
			side=1
			type=Dwarvish Guardsman
		[/filter]
		{VARIABLE_OP i_Guards add -1}
		[if]
			[variable]
				name=i_Guards
				numerical_equals=0
			[/variable]
			[then]
				[message]
					id=Hamel
					message=_"Unfortunately, this was the last guardsman whom our stock of fine ore allowed to be equipped with suitable armor..."
				[/message]
				[disallow_recruit]
					type=Dwarvish Guardsman
					side=1
				[/disallow_recruit]
			[/then]
		[/if]
	[/event]
	[event]
		name=moveto
		[filter]
			side=1
			x = 16, 17, 17, 17
			y = 21, 20, 21, 22
		[/filter]
		[allow_undo]
		[/allow_undo]
		#in case the player triggers this moveto event but never kills Bagdish (which means the final enemy would never be created)
		[if]
			[variable]
				name=b_SideNineAwoken
				boolean_equals=no
			[/variable]
			[then]
				{VARIABLE b_SideNineAwoken yes}
				{WAKEUP_SIDE_NINE}
			[/then]
		[/if]
		[remove_shroud]
			side=1
			x,y=17,19
			radius=2
		[/remove_shroud]
		[redraw]
			clear_shroud=yes
		[/redraw]
		[scroll_to]
			x,y=17,19
		[/scroll_to]
		{CUE_DOOM}
		[message]
			speaker=unit
			message=_"This appears to have been a bridge of dwarven make! A pity it has collapsed."
		[/message]
		[message]
			id=Clarissa
			message=_"We need to find another way then..."
		[/message]
		{FIND_WAY_OBJECTIVES}
	[/event]
	[event]
		name=attack
		[filter]
			side=9
		[/filter]
		[event]
			name=attack
			[filter]
				side=9
			[/filter]
			[remove_shroud]
				side=1
				x,y=17,19
				radius=2
			[/remove_shroud]
			[redraw]
				clear_shroud=yes
			[/redraw]
			{CUE_DOOM}
			[message]
				speaker=second_unit
				message=_"Argh! These beasties are flying from across that chasm somewhere!"
			[/message]
			[message]
				id=Aiglathing
				message=_"They cannot have come from too far away! We have to kill their leader!"
			[/message]
			{FIND_WAY_OBJECTIVES}
		[/event]
	[/event]

	[event]
		name=attack end
		[filter]
			race=undead
		[/filter]
		[if]
			[variable]
				name=bBlowingSnow
				boolean_equals=yes
			[/variable]
			[then]
				[if]
					[variable]
						name=second_unit.id
						equals=Clarissa
					[/variable]
					[then]
						[role_message]
							type=alchemist
							else_speaker=Aiglathing
							message=_"By my beard, what are those things?"
						[/role_message]
					[/then]
					[else]
						[message]
							speaker=second_unit
							message=_"What the devil are these creatures?"
						[/message]
					[/else]
				[/if]
				[message]
					id=Clarissa
					message=_"They are undead. Something I can handle easily."
				[/message]
			[/then]
		[/if]
	[/event]
	[event]
		name=last breath
		[filter]
			id=trap_guard
		[/filter]
		[message]
			id=trap_guard
			message=_"Oh master, I have failed..."
		[/message]
		[if]
			[variable]
				name=b_Lava
				boolean_equals=true
			[/variable]
			[then]
				{DESCEND 3 15 40 21}
			[/then]
			[else]
				{REMOVE_IMAGE $c_StairsPosition.lavaX $c_StairsPosition.lavaY}
				[terrain_mask]
					x,y=1,1
					mask={TEG_MAP 07_The_bridge_is_broken_mask.mask}
				[/terrain_mask]
				{PLACE_IMAGE "items/ladder.png" $c_StairsPosition.waterX $c_StairsPosition.waterY}
				{DESCEND 25 18 51 20}
			[/else]
		[/if]
	[/event]

	[event]
		name=moveto
		[filter]
			id=Hamel
			x=$c_StairsPosition.lavaX
			y=$c_StairsPosition.lavaY
		[/filter]
		[allow_undo]
		[/allow_undo]
		[if]
			[variable]
				name=b_Lava
				boolean_equals=true
			[/variable]
			[then]
				{ASCEND 24 3}
			[/then]
		[/if]
	[/event]

#define CANT_ASCEND_DIALOG
	[message]
		speaker=unit
		message=_"This appears to lead upward! We should explore it!"
	[/message]
	[message]
		id=Hamel
		message=_"Indeed, when we are ready. We better be ready to all go together. I suspect greater foes are waiting for us."
	[/message]
#enddef
	[event]
		name=moveto
		[filter]
			side=1
			x=$c_StairsPosition.lavaX
			y=$c_StairsPosition.lavaY
			[not]
				id=Hamel
			[/not]
		[/filter]
		[allow_undo]
		[/allow_undo]
		[if]
			[variable]
				name=b_Lava
				boolean_equals=true
			[/variable]
			[then]
				{CANT_ASCEND_DIALOG}
			[/then]
		[/if]
	[/event]

	[event]
		name=moveto
		[filter]
			id=Hamel
			x=$c_StairsPosition.waterX
			y=$c_StairsPosition.waterY
		[/filter]
		[allow_undo]
		[/allow_undo]
		[if]
			[variable]
				name=b_Lava
				boolean_equals=false
			[/variable]
			[then]
				{ASCEND 5 3}
			[/then]
		[/if]
	[/event]
	[event]
		name=moveto
		[filter]
			side=1
			x=$c_StairsPosition.waterX
			y=$c_StairsPosition.waterY
			[not]
				id=Hamel
			[/not]
		[/filter]
		[allow_undo]
		[/allow_undo]
		[if]
			[variable]
				name=b_Lava
				boolean_equals=false
			[/variable]
			[then]
				{CANT_ASCEND_DIALOG}
			[/then]
		[/if]
	[/event]
#undef CANT_ASCEND_DIALOG

#define ANIMATE ID HIT NAME
	[animate_unit]
		flag=attack
		[filter]
			id={ID}
		[/filter]
		[primary_attack]
			name={NAME}
		[/primary_attack]
		hits={HIT}
	[/animate_unit]
	[delay]
		time=200
	[/delay]
#enddef
	[event]
		name=die
		[filter]
			id=RoFenthor
		[/filter]
		{TEG_KILL_SIDE 9}
		[message]
			id=Aiglathing
			message=_"It is done."
		[/message]
		[message]
			id=Celylia
			message=_"We seem to be safe for now. We should rest."
		[/message]
		[message]
			id=Hamel
			message=_"I believe we have arrived at the main settlement of our kinsman who went before. The bridge was clearly the outer defense. We should expect to find the main halls a little further in."
		[/message]
		[message]
			id=Celylia
			message=_"If only such excellent defenses could have protected them from what they had found."
		[/message]

		# wmllint: recognize worker1
		{NAMED_UNIT 1 (Dwarvish Fighter) 16 18 worker1 _"Worker" (
			facing=se
		)}
		{NAMED_UNIT 1 (Dwarvish Thunderer) 17 20 worker2 _"Worker" (
			facing=n
		)}
		{NAMED_UNIT 1 (Dwarvish Guardsman) 17 21 worker3 _"Worker" (
			facing=sw
		)}
		[scroll_to]
			x,y=17,19
		[/scroll_to]
		[remove_shroud]
			side=1
			x,y=17,19
			radius=3
		[/remove_shroud]
		[redraw]
			clear_shroud=yes
		[/redraw]
		[message]
			speaker=narrator
			image="wesnoth-icon.png"
			message=_"After the party had rested for a few days, Hamel sent some dwarves back to the other side of the great chasm. With their help, the bridge was quickly repaired."
		[/message]
		{ANIMATE worker1 hit hammer}
		{ANIMATE worker2 miss dagger}
		{ANIMATE worker1 hit hammer}
		[terrain]
			x,y=17,19
			terrain=Qxu^Bs|
		[/terrain]
		[redraw]
			clear_shroud=yes
		[/redraw]
		# wmllint: local spelling Uffff
		[message]
			id=worker1
			message=_"Uffff"
		[/message]
		[endlevel]
			result=victory
			{NEW_GOLD_CARRYOVER 40}
		[/endlevel]
	[/event]
#undef ANIMATE

	#test event
	# 	[event]
	# 		name=turn 2
	# 		[time_area]
	# 			remove=yes
	# 			id=normal_underground
	# 		[/time_area]
	# 		[time_area]
	# 			id=lava_light
	# 			x=1-61
	# 			y=1-33
	# 			{LAVA_UNDERGROUND}
	# 		[/time_area]
	# 	[/event]

	{GENERAL_BONUS_VIA_GOLD id=drake_one 20}
	{GENERAL_BONUS_VIA_GOLD id=drake_two 20}
	{GENERAL_BONUS_VIA_GOLD id=saurian_one 20}
	{GENERAL_BONUS_VIA_GOLD id=saurian_two 20}
	[event]
		name=victory
		[if]
			[variable]
				name=bNarcatsolStored
				equals=yes
			[/variable]
			[then]
				[unstore_unit]
					variable=u_Narcatsol
					x,y=recall,recall
				[/unstore_unit]
			[/then]
		[/if]
		{CLEAR_SCENARIO_VARIABLES}
		{CLEAR_CAMPAIGN_VARIABLES}
	[/event]
	{HERO_DEATHS}
	{TIME_OVER}
[/scenario]

#undef INITIALIZE_CAMPAIGN_VARIABLES
#undef CLEAR_CAMPAIGN_VARIABLES
#undef INITIALIZE_SCENARIO_VARIABLES
#undef CLEAR_SCENARIO_VARIABLES

#undef FOUND_WAY_OBJECTIVES
#undef OTHER_WAY_HINT
#undef FIND_WAY_OBJECTIVES
#undef STAIRS_HIGHLIGHTE
#undef LAVA_COLOR
#undef ANTI_LAVA_COLOR
#undef DESCEND
#undef FINAL_RECRUIT_BASE
#undef ASCEND
#undef WAKEUP_SIDE_NINE
#undef FINAL_WAKEUP_SIDE_NINE
