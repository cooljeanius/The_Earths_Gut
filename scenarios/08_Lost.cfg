#textdomain wesnoth-The_Earths_Gut

#define INITIALIZE_CAMPAIGN_VARIABLES
    {VARIABLE u_Hamel null}
    {VARIABLE i_HamelGold 0}
    {VARIABLE u_HamelRecallList null}
    {VARIABLE u_HamelLoyalUnits null}
    [set_variables]
        name=cRacialTrollsToTake
        [value]
            types="Troll Warrior, Troll"
            {QUANTITY number 2 1 1}
        [/value]
        [value]
            types="Troll Boulderlobber, Troll Rocklobber"
            {QUANTITY number 1 1 1}
        [/value]
        [value]
            types="Troll Fire Wizard, TEG Troll Shaman"
            {QUANTITY number 2 2 2}
        [/value]
        [value]
            types="Troll Frost Wizard, Ice Troll"
            {QUANTITY number 1 1 1}
        [/value]
    [/set_variables]
#enddef
#define CLEAR_CAMPAIGN_VARIABLES
    {CLEAR_VARIABLE s_RegenRingUnit}
    {CLEAR_VARIABLE b_RingStored}
    # no longer used after this scenario:
    {CLEAR_VARIABLE bBlowingSnow}
#enddef
#define INITIALIZE_SCENARIO_VARIABLES
    {VARIABLE_DIFFICULTY_DEPENDANT i_TurnAddUntilRecruit 25 22 19}
    {VARIABLE_DIFFICULTY_DEPENDANT i_TurnAddUntilFinish 36 33 30}
    {VARIABLE krolock_free no}
    {VARIABLE_DIFFICULTY_DEPENDANT i_GenerateEnemyInterval 6 5 4}
    {VARIABLE_DIFFICULTY_DEPENDANT i_TurnCounterEnemy 2 2 2}
    {VARIABLE_DIFFICULTY_DEPENDANT i_IncreaseEnemyIntervalBy 2 1 1}
    {VARIABLE s_EnemyType null}
    {VARIABLE i_EnemyPositionNorth.x 11}
    {VARIABLE i_EnemyPositionNorth.y 3}
    {VARIABLE i_EnemyPositionSouth.x 13}
    {VARIABLE i_EnemyPositionSouth.y 33}
    {VARIABLE troll_outpost_leader_alive yes}
#enddef
#define CLEAR_SCENARIO_VARIABLES
    {CLEAR_VARIABLE i_TurnAddUntilRecruit}
    {CLEAR_VARIABLE i_TurnAddUntilFinish}
    {CLEAR_VARIABLE krolock_free}
    {CLEAR_VARIABLE i_GenerateEnemyInterval}
    {CLEAR_VARIABLE i_TurnCounterEnemy}
    {CLEAR_VARIABLE i_IncreaseEnemyIntervalBy}
    {CLEAR_VARIABLE s_EnemyType}
    {CLEAR_VARIABLE i_EnemyPositionNorth}#2 elements
    {CLEAR_VARIABLE i_EnemyPositionSouth}#2 elements
    {CLEAR_VARIABLE troll_outpost_leader_alive}
#enddef

#define INCREASE_TURNS TURNS_TO_ADD
    #Set the turn limit to a specific number plus the used turns up to this point.
    {VARIABLE i_Turns $turn_number}
    {VARIABLE_OP i_Turns add {TURNS_TO_ADD}}
    [modify_turns]
        value=$i_Turns
    [/modify_turns]
    [message]
        speaker=narrator
        image="wesnoth-icon.png"
        message= _"Hint: The turn limit has been set to $i_Turns|."
    [/message]
    {CLEAR_VARIABLE i_Turns}
#enddef
#define ENEMY_FLYING X Y
    [set_variable]
        name=s_EnemyType
        {QUANTITY rand (Vampire Bat,Blood Bat,Ghost) (Vampire Bat,Vampire Bat,Blood Bat,Ghost,Dread Bat) (Blood Bat,Blood Bat,Ghost,Ghost,Dread Bat,Wraith)}
    [/set_variable]
    {GENERIC_UNIT 4 $s_EnemyType {X} {Y}}
#enddef
#Skeleton,Ghost,Revenant,Skeleton Archer,Bone Shooter,Dark Adept,Ghoul,Chocobone,Wraith
#define ENEMY_WALKING X Y
    [set_variable]
        name=s_EnemyType
        {QUANTITY rand (Walking Corpse,Soulless,Ghoul,Skeleton,Skeleton Archer) (Soulless,Ghoul,Skeleton,Skeleton Archer,Dark Adept) (Ghoul,Skeleton,Skeleton Archer,Dark Adept,Revenant,Bone Shooter)}
    [/set_variable]
    {GENERIC_UNIT 4 $s_EnemyType {X} {Y}}
#enddef
#define ENEMIES_WALKING COORDINATES
    {ENEMY_WALKING ${COORDINATES}.x ${COORDINATES}.y}
    {ENEMY_WALKING ${COORDINATES}.x ${COORDINATES}.y}
#ifdef NORMAL
    {ENEMY_WALKING ${COORDINATES}.x ${COORDINATES}.y}
#endif
#ifdef HARD
    {ENEMY_WALKING ${COORDINATES}.x ${COORDINATES}.y}
    {ENEMY_WALKING ${COORDINATES}.x ${COORDINATES}.y}
#endif
#enddef
#define ENEMIES_FLYING COORDINATES
    {ENEMY_FLYING ${COORDINATES}.x ${COORDINATES}.y}
    {ENEMY_FLYING ${COORDINATES}.x ${COORDINATES}.y}
#ifdef NORMAL
    {ENEMY_FLYING ${COORDINATES}.x ${COORDINATES}.y}
#endif
#ifdef HARD
    {ENEMY_FLYING ${COORDINATES}.x ${COORDINATES}.y}
    {ENEMY_FLYING ${COORDINATES}.x ${COORDINATES}.y}
#endif
#enddef

[scenario]
    id=08_Lost
    next_scenario=09_Unusual_allies
    name= _ "Lost"
    map_data={TEG_MAP 08_Lost.map}
    snapshot=false
    victory_when_enemies_defeated=false
    turns=-1
    disallow_recall=true

    [story]
        [part]
            story= _ "Hamel and his friends were lucky. For the rest of their way back to the main hall, no further enemies challenged them. Upon returning, they took a break and made themselves familiar with the new surroundings."
            background=maps/wesnoth.png
        [/part]
        [part]
            story= _ "The story continues now with someone from the past..."
            background=maps/wesnoth.png
        [/part]
    [/story]
    {TRAVELMAP_LOST}
    {UNDERGROUND}

    {MOOD_UNDERGROUND}

    [side]
        side=1
        controller=human
        type=Advanced Dwarvish Fighter
        id=Hamel
        name= _ "Hamel"
        canrecruit=true
        persistent=true
        save_id=human_player
        shroud=true
        village_gold=0
#ifdef HARD
        recruit=Dwarvish Fighter,Dwarvish Thunderer,Dwarvish Scout
#else
        recruit=Dwarvish Fighter,Dwarvish Thunderer,Alchemist,Dwarvish Scout
#endif
        team_name=dwarves
        {FLAG_VARIANT knalgan}
        {GOLD 0 0 0}
        {INCOME -2 -2 -2}
    [/side]
    [side]
        side=2
        controller=ai
        shroud=true
        hidden=true
        team_name=trolls
        no_leader=yes
        {GOLD 0 0 0}
        {INCOME -2 -2 -2}
    [/side]
    [side]
        side=3
        controller=ai
        team_name=dwarves
        no_leader=yes
        recruit=Troll Whelp,Apprentice Shaman
        share_view=no
        [ai]
            aggression=0.0
            village_value=10.0
            caution=5.0
            recruitment_pattern=fighter,mixed fighter,mixed fighter,mixed fighter
            passive_leader=yes
            grouping=defensive
            [goal]
                name=protect_unit
                [criteria]
                    side=3
                    canrecruit=yes
                [/criteria]
                value=200
                protect_radius=5
            [/goal]
        [/ai]
        {GOLD 100 95 90}
        {INCOME -2 -2 -2}
    [/side]
    [side]
        side=4
        controller=ai
        shroud=true
        hidden=true
        team_name=undead
        no_leader=yes
        [ai]
            # Avoid the player's castle, since it happened that a unit was blocking the keep and the turn needed to kill it the player can't recruit
            # and is then swarmed.
            [avoid]
                terrain=egDC,egDK
            [/avoid]
            [goal]
                name=protect_location
                [criteria]
                    x=27
                    y=10
                [/criteria]
                value=100
                protect_radius=3
            [/goal]
            [goal]
                name=protect_location
                [criteria]
                    x=25
                    y=18
                [/criteria]
                value=100
                protect_radius=3
            [/goal]
            aggression=1.0
            caution=0.0
            [goal]
                [criteria]
                    side=1
                [/criteria]
                value={ON_DIFFICULTY 3 4 5}
            [/goal]
            [goal]
                [criteria]
                    id=Krolock
                [/criteria]
                value={ON_DIFFICULTY 5 6 7}
            [/goal]
            village_value=0.0
        [/ai]
        {GOLD 0 0 0}
        {INCOME -2 -2 -2}
    [/side]

    {SETUP_LUA}
    {SAVEFILE_COMPATIBILITY}
    [event]
        name=prestart
        [objectives]
            summary=_"Starting Objectives:"
            [objective]
                description=_ "Explore!"
                condition=win
            [/objective]
            [objective]
                description=_ "Death of Dulatus"
                condition=lose
            [/objective]
        [/objectives]
        {INITIALIZE_CAMPAIGN_VARIABLES}
        {INITIALIZE_SCENARIO_VARIABLES}

        ############################################################################################
        #leader flip section

        #Fill the Dulatus variable appropriately in debug mode, in case that the storing in scenario 5 was skipped.
#ifdef DEBUG_MODE
        [if]
            [variable]
                name=u_Dulatus.length
                less_than=1
            [/variable]
            [then]
                [unit]
                    type=Dwarvish Stalwart
                    id=Dulatus
                    side=1
                    profile="portraits/Dulatus.png"
                    name= _ "Dulatus"
                    unrenamable=yes
                    [modifications]
                        {TRAIT_LOYAL}
                        {TRAIT_HEALTHY}
                    [/modifications]
                    {IS_HERO}
                    advances_to=Dulatus Level Three
                    to_variable=u_Dulatus
                [/unit]
            [/then]
        [/if]
#endif

        # wmllint: recognize Dulatus
        # wmllint: recognize Hamel
        {HAMEL_TO_DULATUS}
        #store Hamel's loyal units
        [store_unit]
            variable=u_HamelLoyalUnits
            [filter]
                side=1
                [not]
                    id=Dulatus
                [/not]
                [filter_wml]
                    [modifications]
                        {TRAIT_LOYAL}
                    [/modifications]
                [/filter_wml]
            [/filter]
            kill=true
        [/store_unit]
        #store the rest of the recall list
        [store_unit]
            variable=u_HamelRecallList
            [filter]
                side=1
                [not]
                    id=Dulatus
                [/not]
            [/filter]
            kill=true
        [/store_unit]
        #store Hamel's gold
        [store_gold]
            side=1
            variable=i_HamelGold
        [/store_gold]
        [modify_side]
            side=1
            gold=0
        [/modify_side]
        #and no friends to recruit
        [disallow_recruit]
            side=1
            type=Dwarvish Fighter,Dwarvish Thunderer,Alchemist,Dwarvish Scout,Dwarvish Guardsman
        [/disallow_recruit]
        #leader flip section ends
        ############################################################################################

        [store_unit]
            variable=u_Dulatus
            [filter]
                id=Dulatus
            [/filter]
            kill=true
        [/store_unit]
        [if]
            [variable]
                name=bBlowingSnow
                boolean_equals=yes
            [/variable]
            [then]
                {VARIABLE u_Dulatus.x 46}
                {VARIABLE u_Dulatus.y 32}
            [/then]
            [else]
                {VARIABLE u_Dulatus.x 47}
                {VARIABLE u_Dulatus.y 38}
            [/else]
        [/if]
        [hide_unit]
            x=$u_Dulatus.x
            y=$u_Dulatus.y
        [/hide_unit]
        [unstore_unit]
            variable=u_Dulatus
        [/unstore_unit]

        #first set of enemy units, attacks before Dulatus has reached Pelcatlus' home
        {UNIT 4 (Vampire Bat) 40 27 (
            ai_special=guardian
            role=guardian
        )}
#ifdef HARD
        {UNIT 4 (Walking Corpse) 37 34 (
            ai_special=guardian
            role=guardian
        )}
#endif
#ifdef EASY
        [terrain]
            x,y=28,31
            terrain=Qxua
        [/terrain]
#else
        [unit]
            {QUANTITY type () (Vampire Bat) (Blood Bat)}
            side=4
            x=28
            y=31
            ai_special=guardian
            role=guardian
        [/unit]
#endif

        #second set of units
        {UNIT 4 (Vampire Bat) 45 15 (
            ai_special=guardian
            role=guardian
        )}
#ifdef EASY
        [terrain]
            x,y=47,19
            layer=overlay
            terrain="^Edb"
        [/terrain]
#else
        {UNIT 4 {QUANTITY type (Walking Corpse) Soulless Soulless} 47 19 (
            ai_special=guardian
            role=guardian
        )}
#endif
        [if]
            [variable]
                name=s_RegenRingUnit
                equals=Dulatus
            [/variable]
            [then]
                {UNIT 4 {QUANTITY type (Walking Corpse) (Walking Corpse) Soulless} 46 16 (
                    ai_special=guardian
                    role=guardian
                )}
            [/then]
        [/if]
        [unit]
            {QUANTITY type (Vampire Bat) (Blood Bat) (Dread Bat)}
            side=4
            x=44
            y=9
            ai_special=guardian
            role=guardian
        [/unit]
    [/event]

    [event]
        name=start
        [place_shroud]
            side=1
            x=$u_Dulatus.x
            y=$u_Dulatus.y
            radius=6
        [/place_shroud]
        [color_adjust]
            red=-255
            green=-255
            blue=-255
        [/color_adjust]
        [redraw]
            clear_shroud=yes
        [/redraw]
        [message]
            speaker=narrator
            image="units/unknown-unit.png"
            # po: this is Dulatus speaking, but the player isn't supposed to know that yet:
            message= _ "Ahhh... "
        [/message]
        [message]
            speaker=narrator
            image="units/unknown-unit.png"
            # po: again, Dulatus speaking, but the player isn't supposed to know that yet:
            message= _ "Everything is dark..."
        [/message]
        [message]
            speaker=narrator
            image="units/unknown-unit.png"
            # po: again, Dulatus speaking, but even Dulatus isn't supposed to know that, much less the player:
            message= _ "Who am I?"
        [/message]
        [message]
            speaker=narrator
            image="units/unknown-unit.png"
            # po: again, Dulatus speaking, but his identity still hasn't been revealed to anyone yet:
            message= _ "And WHERE am I?"
        [/message]
        [scroll_to]
            x=$u_Dulatus.x
            y=$u_Dulatus.y
        [/scroll_to]
        [unhide_unit]
        [/unhide_unit]
        [delay]
            time=300
        [/delay]
        [remove_shroud]
            side=1
            x=$u_Dulatus.x
            y=$u_Dulatus.y
            radius=2
        [/remove_shroud]
        [redraw]
            clear_shroud=yes
        [/redraw]
        {CLEAR_VARIABLE u_Dulatus}
        {FADE_IN}
        [message]
            id=Dulatus
            message=_"Oh god... I must have been unconscious... how long... I have no idea..."
        [/message]
        [message]
            id=Dulatus
            message=_"My head is spinning like hell."
        [/message]
        [message]
            id=Dulatus
            message=_"Looks like the situation is hopeless..."
        [/message]
        [if]
            [variable]
                name=bBlowingSnow
                boolean_equals=yes
            [/variable]
            [then]
                [message]
                    id=Dulatus
                    #po: The "water" to which he is referring is the river from S05a, "Blowing Snow":
                    message=_"That damned water has dragged me along until that point deep down here. There is no way back against that tough stream. I hope the others have survived."
                [/message]
                [remove_shroud]
                    side=1
                    x,y=44,32
                    radius=1
                [/remove_shroud]
                [redraw]
                    clear_shroud=yes
                [/redraw]
                [message]
                    id=Dulatus
                    # wmllint: local spelling Pheew
                    message=_"Pheew, the river runs into that chasm, but luckily, some rocks protected me from falling down."
                [/message]
            [/then]
            [else]
                [message]
                    id=Dulatus
                    #po: The "earthquake" to which he is referring is from the end of S05b, "Unknown tunnels":
                    message=_"That earthquake let the ceiling collapse... the way back is destroyed. I hope the others have survived."
                [/message]
                [message]
                    id=Dulatus
                    message=_"I wonder where these undead have come from and why the trolls have been fighting against them."
                [/message]
            [/else]
        [/if]
        [message]
            id=Dulatus
            message=_"My friends can only suppose I'm dead... I'll see if they are right..."
        [/message]
        [message]
            id=Dulatus
            message=_"Anyway, it seems they left me back here, or rather, had no other choice but to do so."
        [/message]
        [message]
            id=Dulatus
            message=_"Now let's see where this tunnel goes."
        [/message]
        [heal_unit]
            [filter]
                id=Dulatus
            [/filter]
            amount=0
            moves=full
            restore_attacks=yes
        [/heal_unit]

        {SET_LABEL 8 15 _"The troll outpost"}
        {PLACE_IMAGE "items/altar.png" 32 24}
        {PLACE_IMAGE "items/hammer-runic.png" 33 24}
        {ITM_WISHINGWELL 34 24}
        {TEG_BRAZIER 32 25}
    [/event]

    {SET_SCENARIO_STATUS_TO (
        [option]
            # po: debug option; completes sentence starting with "Set scenario status to...":
            message=_"Krolock being freed."
            [command]
                [move_unit]
                    to_x=36
                    to_y=25
                    side=1
                    fire_event=yes
                [/move_unit]
                [move_unit]
                    to_x=45
                    to_y=10
                    side=1
                    fire_event=yes
                [/move_unit]
                [kill]
                    role=nuisance
                [/kill]
                [kill]
                    role=guardian
                [/kill]
                [capture_village]
                    side=1
                    x=31-50
                [/capture_village]
                [fire_event]
                    name=troll_patrol
                [/fire_event]
            [/command]
        [/option]
        [option]
            # po: debug option; completes sentence starting with "Set scenario status to...":
            message=_"to just before discovering Krolock."
            [command]
                [move_unit]
                    to_x=36
                    to_y=25
                    side=1
                    fire_event=yes
                [/move_unit]
                [teleport]
                    [filter]
                        id=Dulatus
                    [/filter]
                    x=45
                    y=11
                [/teleport]
                [teleport]
                    [filter]
                        # wmllint: recognize Pelcatlus
                        id=Pelcatlus
                    [/filter]
                    x=44
                    y=11
                [/teleport]
                [kill]
                    role=guardian
                    fire_event=yes
                [/kill]
            [/command]
        [/option]
    )}

    [event]
        name=moveto
        [filter]
            side=1
            x=44-47,45-47
            y=31-34,35-35
        [/filter]
        [allow_undo]
        [/allow_undo]
        [if]
            [variable]
                name=bBlowingSnow
                boolean_equals=no
            [/variable]
            [then]
                [remove_shroud]
                    side=1
                    x,y=45,33
                    radius=1
                [/remove_shroud]
                [redraw]
                    clear_shroud=yes
                [/redraw]
                [message]
                    id=$unit.id
                    #po: "$unit.id" is most likely Dulatus here; if he didn't come from S05a ("Blowing Snow"), then this is his first time seeing this river:
                    message=_"There's a river running down here... but the current is way too strong to escape this way. I wonder where it may come from."
                [/message]
            [/then]
        [/if]
    [/event]
    [event]
        name=moveto
        [filter]
            side=1
            x=44-47
            y=35-38
        [/filter]
        [allow_undo]
        [/allow_undo]
        [if]
            [variable]
                name=bBlowingSnow
                boolean_equals=yes
            [/variable]
            [then]
                [remove_shroud]
                    side=1
                    x,y=47,37
                    radius=1
                [/remove_shroud]
                [redraw]
                    clear_shroud=yes
                [/redraw]
                [message]
                    id=$unit.id
                    #po: "$unit.id" is most likely Dulatus here; if he didn't come from S05b ("Unknown Tunnels"), then this is his first time seeing this path:
                    message=_"It seems that southern path has caved in. I wonder where it had been leading to. There's no way to get through."
                [/message]
            [/then]
        [/if]
    [/event]
    [event]
        #message about the river noise in the chasm
        name=moveto
        [filter]
            side=1
            x=41,40,39,38,37,37,36,35,35,36
            y=33,32,33,33,34,35,33,33,32,31
        [/filter]
        [allow_undo]
        [/allow_undo]
        [message]
            id=$unit.id
            #po: "$unit.id" is most likely Dulatus here:
            message=_"I hear a roaring sound down in this chasm... it must be water."
        [/message]
        [sound_source]
            id=roaring_sound_from_chasm
            # FIXME: transition between these sounds isn't exactly very smooth:
            sounds=loudstream.ogg,stream[1~7].ogg,waterfall[1~3].ogg
            x,y=42,32
        [/sound_source]
    [/event]

#define FORGE_HAMMER
    [sound]
        name=mace.wav
    [/sound]
    [delay]
        time=1000
    [/delay]
#enddef
    [event]
        name=moveto
        [filter]
            side=1
            x=36,41,41,39-45
            y=25,26,23,18-22
        [/filter]
        [allow_undo]
        [/allow_undo]
        [message]
            id=Dulatus
            message=_"What? Who's there?"
        [/message]
        [store_unit]
            variable=u_Dulatus
            [filter]
                id=Dulatus
            [/filter]
        [/store_unit]
        [unit]
            type=Dwarvish Ulfserker
            id=Pelcatlus
            name= _ "Pelcatlus"
            side=1
            unrenamable=true
            animate=true
            profile="portraits/Pelcatlus.png"
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_RESILIENT}
                {TRAIT_HEALTHY}
                {TRAIT_STRONG}
                {TEG_ABILITY_DUNGEON_SURVIVAL}
            [/modifications]
            x=$u_Dulatus.x
            y=$u_Dulatus.y
            {IS_LOYAL}
        [/unit]
        [message]
            id=Pelcatlus
            message=_"You stinky creature dare to disturb me! I'll - oh -"
        [/message]
        [message]
            id=Pelcatlus
            message=_"It's been a long time that I've seen any other LIVING being except a troll every now and then... and you're even a dwarf! Welcome to my mediocre home."
        [/message]
        [message]
            id=Dulatus
            message=_"Thanks, I'd thought I'd die all alone down here... now we'll die together..."
        [/message]
        [message]
            id=Pelcatlus
            message=_"It is possible to survive. The fish from that lake and my mushroom 'garden' kept me alive."
        [/message]
        [message]
            id=Pelcatlus
            message=_"All those years here have only toughened me, I'm guessing. And I can no longer stop once I've started a fight until my opponent is dead."
        [/message]
        [message]
            id=Pelcatlus
            message=_"There's a river running into the cave, it washed me down once ago... you may have noticed it."
        [/message]
        [if]
            [variable]
                name=bBlowingSnow
                boolean_equals=yes
            [/variable]
            [then]
                [message]
                    id=Dulatus
                    message=_"Yes, the same thing happened to me."
                [/message]
            [/then]
            [else]
                [message]
                    id=Dulatus
                    message=_"I've heard its roar in the chasm. I've come through the southern tunnel, but now it has collapsed."
                [/message]
                [message]
                    id=Pelcatlus
                    message=_"Is that so? I've explored that passage a thousand times."
                [/message]
                [message]
                    id=Dulatus
                    message=_"Maybe the earthquake that has blocked it now also opened a way some time before."
                [/message]
            [/else]
        [/if]
        [remove_shroud]
            side=1
            x,y=33,25
            radius=2
        [/remove_shroud]
        [redraw]
            clear_shroud=yes
        [/redraw]
        [message]
            id=Dulatus
            message=_"By the way, you have a forge there, I see?"
        [/message]
        [message]
            id=Pelcatlus
            message=_"Yes, your weapons cannot be good enough as they are if you want to survive here."
        [/message]
        [if]
            [variable]
                name=b_RingStored
                boolean_equals=true
            [/variable]
            [then]
                [message]
                    id=Dulatus
                    message=_"I still have a magical regeneration ring we acquired in a fight, but it is too rusty."
                [/message]
                [message]
                    id=Pelcatlus
                    message=_"Feel free to use my forge."
                [/message]
                [move_unit]
                    id=Dulatus
                    to_x=33
                    to_y=24
                [/move_unit]
                {REMOVE_IMAGE 33 24}
                [delay]
                    time=400
                [/delay]
                [move_unit]
                    id=Dulatus
                    to_x=32
                    to_y=24
                [/move_unit]
                {TEG_LIT_BRAZIER 32 25}
                [redraw]
                    clear_shroud=yes
                [/redraw]
                {FORGE_HAMMER}
                {FORGE_HAMMER}
                {FORGE_HAMMER}
                {REGEN_RING Dulatus "Dulatus" no}
                [message]
                    id=Dulatus
                    message=_"Wow, that feels great!"
                [/message]
                {TEG_BRAZIER 32 25}
                [redraw]
                    clear_shroud=yes
                [/redraw]
                [move_unit]
                    id=Dulatus
                    to_x=33
                    to_y=24
                [/move_unit]
                [delay]
                    time=300
                [/delay]
                {PLACE_IMAGE "items/hammer-runic.png" 33 24}
                [move_unit]
                    id=Dulatus
                    to_x=$u_Dulatus.x
                    to_y=$u_Dulatus.y
                [/move_unit]
            [/then]
            [else]
                [message]
                    id=Dulatus
                    #po: "them" = his weapons:
                    message=_"Hm, let me check them... actually, I think they're probably fine."
                [/message]
                [message]
                    id=Pelcatlus
                    message=_"I guess that's true; my forge is mostly useful for removing rust, and I don't see much rust on your weapons..."
                [/message]
            [/else]
        [/if]
        [message]
            id=Dulatus
            message=_"Me and my comrades have been on an expedition to find new mines. Now they surely believe I'm dead."
        [/message]
        [message]
            id=Dulatus
            message=_"So we can't get back, the only way is forward through the mountain. What about the other way, to the north? Where does it go?"
        [/message]
        [message]
            id=Pelcatlus
            message=_"I don't really know, but there are only a lot of nasty creatures and trolls."
        [/message]
        [message]
            id=Dulatus
            message=_"Then let's find it out. I want to meet my friends again somewhen."
        [/message]
#ifdef EASY
        [message]
            id=Dulatus
            #po: a hint for players on EASY mode on how to use units with the "berserk" special like Pelcatlus:
            message=_"And better let me walk in front of you... you can't stop fighting, you know."
        [/message]
#endif
        {CLEAR_VARIABLE u_Dulatus}
        ############################################################################################
        {INCREASE_TURNS $i_TurnAddUntilRecruit}
    [/event]
#undef FORGE_HAMMER

    [event]
        name=die
        [filter]
            race=bats
        [/filter]
        [event]
            name=attack
            [filter]
                race=bats
            [/filter]
            [filter_second]
                side=1
            [/filter_second]
            [message]
                speaker=second_unit
                #po: speaker = side 1 unit; most likely either Dulatus or Pelcatlus,
                #po: although it could also be a troll if the player is using debug mode:
                message=_"Shitty bats!"
            [/message]
        [/event]
    [/event]

    {FORCE_CHANCE_TO_HIT (id=nasty_walking_corpse) (id=Krolock) 0 ()}
    [event]
        name=moveto
        [filter]
            side=1
            x=45,44,43-43,42-42,41-41,43,40-40
            y=10,09,09-10,05-09,07-10,7,05-10
        [/filter]
        [allow_undo]
        [/allow_undo]
        [remove_shroud]
            side=1
            x,y=39,7
            radius=2
        [/remove_shroud]
        # wmllint: recognize Krolock
        {UNIT 2 (Troll Whelp) 39 7 (
            id=Krolock
            name= _"Krolock"
            hitpoints=19
            profile="portraits/Krolock.png"
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_RESILIENT}
                {TRAIT_FEARLESS}
            [/modifications]
            advances_to=Troll Hero
        )}
        [unit_overlay]
            id=Krolock
            image="items/cage.png"
        [/unit_overlay]
        [modify_unit]
            [filter]
                id=Krolock
            [/filter]
            [variables]
                max_moves=$this_unit.max_moves
            [/variables]
            max_moves=0
        [/modify_unit]
        # wmllint: recognize nasty_skeleton
        {UNIT 4 (Skeleton Archer) 39 6 (
            id=nasty_skeleton
            role=nuisance
#ifdef EASY
#ifdef DEBUG_MODE
            hitpoints=19 # (out of 31)
#endif
#endif
        )}
        # wmllint: recognize nasty_walking_corpse
        {UNIT 4 (Walking Corpse) 39 8 (
            id=nasty_walking_corpse
            role=nuisance
        )}
#ifdef EASY
        [terrain]
            x,y=46,6
            layer=overlay
            terrain="^Edb"
        [/terrain]
#else
        [remove_shroud]
            side=1
            x,y=46,6
            radius=1
        [/remove_shroud]
        [redraw]
            clear_shroud=yes
        [/redraw]
        # wmllint: recognize nasty_ghost
        {UNIT 4 {QUANTITY type (Ghost) Ghost Wraith} 46 6 (
            id=nasty_ghost
            role=nuisance
        )}
#endif
        [message]
            id=$unit.id
            #po: speaker = side 1 unit that has discovered Krolock; most likely either Dulatus or Pelcatlus:
            message=_"Hey... there's something going on here. A Troll Whelp is being tortured by undead, it seems."
        [/message]
        {CUE_BATTLE}
        [message]
            id=nasty_skeleton
            message=_"Tell us, mite, where's the troll village?"
        [/message]
        [message]
            id=Krolock
            message=_"Feel my 'tiny' fist, intruder!"
        [/message]
        [message]
            id=Dulatus
            message=_"Hm... this could be the chance we needed."
        [/message]
        [message]
            id=Pelcatlus
            message=_"What do you mean? Shall we HELP him? Trolls often prevent us from mining."
        [/message]
        [message]
            id=Dulatus
            message=_"Trolls are enemies, but the undead also are. Let's try new methods... an alliance with the trolls could be the key to survival."
        [/message]
        [modify_unit]
            [filter]
                id=Krolock
            [/filter]
            side=3
        [/modify_unit]
        {MAKE_HERO Krolock}
        [objectives]
            summary=_"Temporary Objectives:"
            [objective]
                description=_ "Rescue Krolock the Troll Whelp!"
                condition=win
            [/objective]
            [objective]
                description=_ "Death of Krolock"
                condition=lose
            [/objective]
            [objective]
                description=_ "Death of Dulatus"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]

        [event]
            name=turn refresh
            [filter_side]
                side=4
            [/filter_side]
            [modify_unit]
                [filter]
                    id=nasty_ghost
                [/filter]
                moves=0
            [/modify_unit]
        [/event]
    [/event]

#define FREE_KROLOCK
    [remove_unit_overlay]
        id=Krolock
        image="items/cage.png"
    [/remove_unit_overlay]
    {VARIABLE krolock_free yes}
#enddef
    [event]
        name=moveto
        [filter]
            side=1
            x=40,40,39
            y=7,6,8
        [/filter]
        [allow_undo]
        [/allow_undo]
        {FREE_KROLOCK}
        [message]
            id=Krolock
            message=_"Thank you for freeing me."
        [/message]
    [/event]
#define REMOVE_PATROL_UNIT ID TYPE X Y
    [kill]
        id={ID}
    [/kill]
    {FAKE_UNIT_MOVE {X} 27 {Y} 3 2 ({TYPE}) ()}
#enddef
    [event]
        name=die
        first_time_only=false
        [filter]
            role=nuisance
        [/filter]
        [filter_condition]
            [not]
                [have_unit]
                    role=nuisance
                [/have_unit]
            [/not]
        [/filter_condition]
        [teg_xp_to_killer]
        [/teg_xp_to_killer]
        [fire_event]
            name=troll_patrol
        [/fire_event]
    [/event]

    [event]
        name=troll_patrol
        {FREE_KROLOCK}
        [message]
            id=Krolock
            message=_"Thank you."
        [/message]
        [remove_shroud]
            side=1
            x,y=37,8
            radius=2
        [/remove_shroud]
        [redraw]
            clear_shroud=yes
        [/redraw]
        [move_unit]
            id=Dulatus
            to_x=37
            to_y=8
        [/move_unit]
        [move_unit]
            id=Krolock
            to_x=38
            to_y=7
        [/move_unit]
        [move_unit]
            id=Pelcatlus
            to_x=38
            to_y=8
        [/move_unit]
        [message]
            id=Dulatus
            message=_"That's it. We've defeated your nuisances, Krolock."
        [/message]
        [message]
            id=Pelcatlus
            message=_"It was a hard fight."
        [/message]
        [message]
            id=Krolock
            message=_"Why did you do that? You're the first dwarves that haven't stolen our gold or expelled us from our homes."
        [/message]
        [message]
            id=Dulatus
            message=_"Umm... I..."
        [/message]

        {FAKE_UNIT_MOVE 27 36 14 8 2 (TEG Troll Shaman) ()}
        # wmllint: recognize patrol_troll_shaman
        {UNIT 2 (TEG Troll Shaman) 36 8 (
            id=patrol_troll_shaman
            generate_name=true
        )}
        {FAKE_UNIT_MOVE 27 36 14 7 2 (Apprentice Shaman) ()}
        # wmllint: recognize patrol_whelp_shaman
        {UNIT 2 (Apprentice Shaman) 36 7 (
            id=patrol_whelp_shaman
            generate_name=true
        )}
        {FAKE_UNIT_MOVE 27 39 14 8 2 (Troll) ()}
        # wmllint: recognize patrol_troll
        {UNIT 2 (Troll) 39 8 (
            id=patrol_troll
            generate_name=true
        )}
        {FAKE_UNIT_MOVE 27 38 14 6 2 (Troll Whelp) ()}
        # wmllint: recognize patrol_troll_whelp
        {UNIT 2 (Troll Whelp) 38 6 (
            id=patrol_troll_whelp
            generate_name=true
        )}
        {CUE_DOOM}
        [message]
            id=Dulatus
            message=_"Uh - oh..."
        [/message]
        [message]
            id=patrol_troll
            message=_"What is this? You dwarves are never satisfied, are you!? You can only think of more ore and gems. Kill them."
        [/message]
        [message]
            id=patrol_troll_shaman
            message=_"Wait a second... what has happened here, Krolock?"
        [/message]
        [message]
            id=Krolock
            message=_"My group was looking for mushrooms as an undead patrol beset us. Although we defeated many of them, all my comrades lost their lives. Then the remaining undead captured me to get information about where our village is. That's when these dwarves came and saved my life."
        [/message]
        [message]
            id=patrol_troll_whelp
            message=_"'Saved your life' you say!?"
        [/message]
        [message]
            id=Pelcatlus
            message=_"Yes. Those undead are our enemies, too. They attack us for nothing."
        [/message]
        [message]
            id=Dulatus
            message=_"A group of dwarves is traveling towards this cave system. We are willing to help you with the undead. (<i>thinks: Hopefully this is true... but I have no other choice now.</i>)"
        [/message]
        [message]
            id=patrol_troll_shaman
            message=_"(<i>thinks: An alliance could be helpful... in respect of our losses against the undead...</i>)"
        [/message]
        [message]
            id=patrol_troll_shaman
            message=_"Well, then... you help Krolock to get back to our outpost in the west, then we'll see what we do with you."
        [/message]
        [message]
            id=patrol_troll_shaman
            message=_"We will search for other undead now. Here is some gold for you. Look for an old dwarvish castle in southwestern direction."
        [/message]
        [gold]
            side=1
            {QUANTITY amount 160 140 120}
        [/gold]
        [modify_unit]
            [filter]
                id=Krolock
            [/filter]
            max_moves=$this_unit.variables.max_moves
            side=1
        [/modify_unit]
        {REMOVE_PATROL_UNIT patrol_troll_shaman (TEG Troll Shaman) 36 8}
        {REMOVE_PATROL_UNIT patrol_whelp_shaman (Apprentice Shaman) 36 7}
        {REMOVE_PATROL_UNIT patrol_troll (Troll) 39 8}
        {REMOVE_PATROL_UNIT patrol_troll_whelp (Troll Whelp) 38 6}
        [message]
            id=Krolock
            message=_"Some of my friends have stayed."
        [/message]
        [allow_recruit]
            side=1
            type=Troll Whelp,Apprentice Shaman
        [/allow_recruit]
        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message=_"You may now recruit Troll Whelps and Apprentice Shamans."
        [/message]
        [remove_shroud]
            side=1
            x=42-50
            y=4-8
        [/remove_shroud]
        [redraw]
            clear_shroud=yes
        [/redraw]

        {INCREASE_TURNS $i_TurnAddUntilFinish}
        [objectives]
            summary=_"Final Objectives:"
            [objective]
                description=_ "Krolock must reach the troll outpost's castle."
                condition=win
            [/objective]
            [objective]
                description=_ "Death of Krolock"
                condition=lose
            [/objective]
            [objective]
                description=_ "Death of Dulatus"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
            [note]
                description=_"No early finish bonus in case the troll outpost leader is dead when the scenario ends."
            [/note]
        [/objectives]
        # wmllint: recognize troll_outpost_leader
        {UNIT 3 (Troll Fire Wizard) 5 16 (
            id=troll_outpost_leader
            generate_name=true
            canrecruit=true
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_RESILIENT}
                {TRAIT_HEALTHY}
                {TRAIT_DEXTROUS}
            [/modifications]
        )}
        [modify_side]
            side=1
            village_gold=1
            {INCOME 0 0 0}
        [/modify_side]
        [modify_side]
            side=3
            {INCOME 0 0 0}
        [/modify_side]
        [modify_side]
            side=4
            [ai]
                aggression={ON_DIFFICULTY 0.6 0.7 0.8}
            [/ai]
        [/modify_side]

        [modify_unit]
            [filter]
                side=1
            [/filter]
            moves="$($this_unit.max_moves)"
        [/modify_unit]

        {ENEMIES_FLYING i_EnemyPositionNorth}
        {ENEMIES_FLYING i_EnemyPositionSouth}

        [modify_unit]
            [filter]
                side=4
            [/filter]
            moves=0
            [status]
                slowed=yes
            [/status]
        [/modify_unit]

        {ENEMIES_WALKING i_EnemyPositionNorth}
        {ENEMIES_WALKING i_EnemyPositionSouth}

        [event]
            name=new turn
            first_time_only=false
            [if]
                [variable]
                    name=i_TurnCounterEnemy
                    numerical_equals=$i_GenerateEnemyInterval
                [/variable]
                [then]
                    {VARIABLE i_TurnCounterEnemy 0}
                    {VARIABLE_OP i_GenerateEnemyInterval add $i_IncreaseEnemyIntervalBy}

                    {ENEMIES_WALKING i_EnemyPositionNorth}
                    {ENEMIES_FLYING i_EnemyPositionNorth}
                    {ENEMIES_WALKING i_EnemyPositionSouth}
                    {ENEMIES_FLYING i_EnemyPositionSouth}
                [/then]
                [else]
                    {VARIABLE_OP i_TurnCounterEnemy add 1}
                [/else]
            [/if]
        [/event]

        [event]
            name=die
            first_time_only=false
            [filter]
                side=4
            [/filter]
            [filter_second]
                side=3
            [/filter_second]
            [if]
                [not]
                    [have_unit]
                        side=4
                    [/have_unit]
                [/not]
                [then]
                    [store_locations]
                        terrain=Qxu
                        [filter_vision]
                            side=1
                            visible=no
                        [/filter_vision]
                        include_borders=no
                        variable=possible_bat_locs
                    [/store_locations]
                    [if]
                        [variable]
                            name=possible_bat_locs.length
                            greater_than=0
                        [/variable]
                        [then]
                            {RANDOM 0..$possible_bat_locs.length}
#ifdef DEBUG_MODE
                            [message]
                                speaker=narrator
                                image=wesnoth-icon.png
                                #po: debug message:
                                message=_"spawning flying enemies at $possible_bat_locs[$random].x,$possible_bat_locs[$random].y"
                            [/message]
#endif
                            {ENEMIES_FLYING possible_bat_locs[$random]}
                            {CLEAR_VARIABLE random}
                        [/then]
                        [else]
#ifdef DEBUG_MODE
                            [message]
                                speaker=narrator
                                image=wesnoth-icon.png
                                #po: debug message:
                                message=_"oops, there's nowhere left to spawn additional flying enemies"
                            [/message]
#else
                            [redraw][/redraw]
#endif
                        [/else]
                    [/if]
                [/then]
                [else]
#ifdef DEBUG_MODE
                    [store_unit]
                        [filter]
                            side=4
                        [/filter]
                        variable=s4_units
                        kill=no
                    [/store_unit]
                    [if]
                        [lua]
                            code=<<return wesnoth.game_config.debug_mode>>
                        [/lua]
                        [then]
                            [message]
                                speaker=narrator
                                image=wesnoth-icon.png
                                #po: debug message; $s4_units.length will be off-by-one but whatever;
                                #po: if someone is playing with debug mode on, they ought to be able to figure it out:
                                message=_"side 4 still has $s4_units.length unit(s) left"
                            [/message]
                        [/then]
                        [else]
#ifdef DEBUG_MSG
                            {DEBUG_MSG "side 4 still has $s4_units.length unit(s) left"}
#else
                            [wml_message]
                                message=_"side 4 still has $s4_units.length unit(s) left"
                                logger=debug
                            [/wml_message]
#endif
                        [/else]
                    [/if]
                    {CLEAR_VARIABLE s4_units}
#else
                    [redraw][/redraw]
#endif
                [/else]
            [/if]
        [/event]
    [/event]
#undef REMOVE_PATROL_UNIT
#undef FREE_KROLOCK

    [event]
        name=prerecruit
        [filter]
            side=1
        [/filter]
        [message]
            speaker=narrator
            image="wesnoth-icon.png"
            # po: string splicing here:
            message= _"Hint:" + _"
After a following scenario, you will only be allowed to keep in your recall list at maximum" + "
" + {LIMITED_TROLLS_MESSAGE} + _"
in addition to Krolock. Remaining available Trolls, Troll Warriors, Boulderlobbers or Rocklobbers can be Troll Whelps, remaining Troll Fire Wizards, Troll Shamans, Troll Frost Wizards or Ice Trolls can be Apprentice Shamans (if there are enough). Remaining Troll Whelps can't be transferred to Apprentice Shamans or vice versa. You will be able to choose the units that stay."
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            id=Krolock
            x=04-06,05
            y=15-16,17
        [/filter]
        [if]
            [variable]
                name=troll_outpost_leader_alive
                equals=no
            [/variable]
            [then]
                [unit]
                    type=TEG Troll Shaman
                    x=1
                    y=9
                    id=troll_outpost_leader
                    name=_"Tunnel Guard"
                    side=3
                [/unit]
                [move_unit]
                    id=troll_outpost_leader
                    to_x=5
                    to_y=16
                [/move_unit]
            [/then]
        [/if]
        [message]
            id=Krolock
            message=_"Thank you, friends."
        [/message]
        [message]
            id=Krolock
            message=_"The tunnel in the southwest of this base leads to a former dwarvish settlement, as far as I can tell."
        [/message]
        [message]
            id=troll_outpost_leader
            message=_"Wait a moment, these are the dwarves that saved your life? Our patrol told me about that."
        [/message]
        [message]
            id=Krolock
            message=_"Yes. They-"
        [/message]
        [message]
            id=troll_outpost_leader
            message=_"Then you all take the way to the northwest; the leader of our tribe wants to know the dwarves who saved his son's life."
        [/message]
        [if]
            [variable]
                name=troll_outpost_leader_alive
                equals=yes
            [/variable]
            [then]
                [endlevel]
                    result=victory
                    {NEW_GOLD_CARRYOVER 40}
                [/endlevel]
            [/then]
            [else]
                [endlevel]
                    result=victory
                    bonus=no
                    {NEW_GOLD_CARRYOVER 40}
                [/endlevel]
            [/else]
        [/if]
    [/event]

    [event]
        name=victory
        {CLEAR_SCENARIO_VARIABLES}
        {CLEAR_CAMPAIGN_VARIABLES}
    [/event]

    [event]
        name=last breath
        [filter]
            id=troll_outpost_leader
        [/filter]
        {VARIABLE troll_outpost_leader_alive no}
        [remove_shroud]
            side=1
            x=$unit.x
            y=$unit.y
            radius=2
        [/remove_shroud]
        [redraw]
            clear_shroud=yes
        [/redraw]
        [message]
            id=Krolock
            # po: this is the last breath of the troll outpost leader:
            message=_"Uncle, noooo!"
        [/message]
        [message]
            id=troll_outpost_leader
            message=_"Arghhh..."
        [/message]
        [kill]
            id=$unit.id
            animate=true
        [/kill]
    [/event]
    [event]
        name=die
        [filter]
            id=Krolock
        [/filter]
        [message]
            id=Dulatus
            # po: this is Krolock's last breath:
            message=_"Our last chance to get out is destroyed..."
        [/message]
        [message]
            id=Pelcatlus
            message=_"Anyway, let's return to my home."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    [event]
        name=last breath
        [filter]
            id=Dulatus
        [/filter]
        # wmllint: local spelling Uahh!
        [message]
            id=Dulatus
            message= _ "Uahh! The cave has finished me..."
        [/message]
        [kill]
            id=$unit.id
            animate=true
        [/kill]
        [message]
            id=Pelcatlus
            # po: "His friends" = the other dwarves; "Him" = Dulatus:
            message= _ "His friends will never see him again..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    [event]
        name=die
        [filter]
            id=Pelcatlus
        [/filter]
        [message]
            id=Dulatus
            message= _ "He was the most frenzied dwarf I've ever seen..."
        [/message]
    [/event]
    {TIME_OVER_DULATUS_SCENARIOS}
[/scenario]

#undef INITIALIZE_CAMPAIGN_VARIABLES
#undef CLEAR_CAMPAIGN_VARIABLES
#undef INITIALIZE_SCENARIO_VARIABLES
#undef CLEAR_SCENARIO_VARIABLES

#undef INCREASE_TURNS
#undef ENEMY_FLYING
#undef ENEMY_WALKING
#undef ENEMIES_FLYING
#undef ENEMIES_WALKING
