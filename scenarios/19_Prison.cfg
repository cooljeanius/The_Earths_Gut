#textdomain wesnoth-The_Earths_Gut

#define INITIALIZE_CAMPAIGN_VARIABLES
#enddef
#define CLEAR_CAMPAIGN_VARIABLES
    {CLEAR_VARIABLE u_Dwarves}
    {CLEAR_VARIABLE uMages}
#enddef
#define INITIALIZE_SCENARIO_VARIABLES
    {VARIABLE locPrisoners $null}
    {VARIABLE locCellDoors $null}
    {VARIABLE bExecute no}
    {VARIABLE_DIFFICULTY_DEPENDANT nWarningTurn 39 36 33}
    {VARIABLE_DIFFICULTY_DEPENDANT nExecutionDelay 8 7 6}
    {VARIABLE nExecutionStartTurn "$($nWarningTurn + $nExecutionDelay|)"}
#enddef
#define CLEAR_SCENARIO_VARIABLES
    {CLEAR_VARIABLE locPrisoners}
    {CLEAR_VARIABLE locCellDoors}
    {CLEAR_VARIABLE bExecute}
    {CLEAR_VARIABLE nWarningTurn}
    {CLEAR_VARIABLE nExecutionStartTurn}
    {CLEAR_VARIABLE nExecutionDelay}
#enddef

[scenario]
    ################################################################
    # scenario head

    id=19_Prison
    next_scenario=20t_A_cry_for_help
    name= _ "Prison"
    map_data={TEG_MAP 19_Prison.map}
    victory_when_enemies_defeated=no
#ifndef DEBUG_MODE
    disallow_recall=yes
#endif
    turns=-1
    {UNDERGROUND}
    {MOOD_BATTLE}

    [story]
        [part]
            story= _ "For a dwarven scout, the bare rocky ground of dark tunnels appears like a book. Tiny fresh scratches or pebbles showed Hamel's band the way the undead had taken, just as easily as if it had been elven scouts reading traces in the forest."
            background=maps/wesnoth.png
        [/part]
        [part]
            story= _ "They followed quietly and carefully the route their comrades had presumably been abducted, so as to not run into a fatal assault again which they anyway could hardly survive due to their limited numbers."
            background=maps/wesnoth.png
        [/part]
        [part]
            story= _ "Finally they arrived at what appeared to be some major facility of their enemies..."
            background=maps/wesnoth.png
        [/part]
    [/story]
    {TRAVELMAP_UNDEAD_PRISON}

    ################################################################
    #sides
    [side]
        # player
        side=1
        controller=human
        type=Advanced Dwarvish Fighter
        id=Hamel
        name= _ "Hamel"
        canrecruit=yes
        persistent=yes
        save_id=human_player
        team_name=dwarves
        {FLAG_VARIANT knalgan}
        {GOLD 0 0 0}
        {INCOME -2 -2 -2}
        village_gold=0
        shroud=yes
    [/side]
    [side]
        # main enemy side; prison boss doing executions
        side=2
        controller=ai
        no_leader=yes
        team_name=enemies
        hidden=yes
        recruit=Deathblade,Revenant,Bone Shooter,Necrophage
        [unit]
            type=Lich
            id="Ro'Boreth"
            side=2
            canrecruit=yes
            placement=leader
            name=_"Ro'Boreth"
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_RESILIENT}
                {TRAIT_HEALTHY}
            [/modifications]
        [/unit]
        [ai]
            aggression=1.0
            caution=0.0
            passive_leader=yes
        [/ai]
        {GOLD 0 0 0}
        {INCOME -2 -2 -2}
    [/side]
    [side]
        # dwarvish prison guards
        side=3
        controller=ai
        no_leader=yes
        team_name=enemies
        hidden=yes
        recruit="Dwarvish Masked Fighter,Dwarvish Masked Guardsman,Dwarvish Masked Thunderer"
        [unit]
            type=Dwarvish Masked Steelclad
            generate_name=yes
            id=prison_guard
            side=3
            canrecruit=yes
            placement=leader
            [modifications]
                {TRAIT_RESILIENT}
                {TRAIT_STRONG}
                {TRAIT_HEALTHY}
                {TRAIT_SLOW}
            [/modifications]
        [/unit]
        [ai]
            aggression=1.0
            caution=0.0
            passive_leader=yes
        [/ai]
        {GOLD 0 0 0}
        {INCOME -2 -2 -2}
    [/side]
    [side]
        # doors
        side=4
        controller=ai
        no_leader=yes
        team_name=enemies
        hidden=yes
        [ai]
            ai_algorithm=idle_ai
        [/ai]
    [/side]
    [side]
        # own units before freeing them
        side=5
        controller=ai
        no_leader=yes
        team_name=dwarves
        share_view=yes
        share_maps=yes
        [ai]
            ai_algorithm=idle_ai
        [/ai]
    [/side]
    [side]
        # executioner
        side=6
        controller=ai
        no_leader=yes
        team_name=enemies
        hidden=yes
        facing=sw
        [ai]
            ai_algorithm=idle_ai
        [/ai]
    [/side]
    [side]
        # friend in the middle
        side=7
        controller=null
        no_leader=yes
        team_name=dwarves
        hidden=yes
    [/side]
    [side]
        # creatures in the lake
        side=8
        controller=ai
        no_leader=yes
        team_name=enemies
        hidden=yes
        [ai]
            [avoid]
                terrain=!,Ww
            [/avoid]
        [/ai]
    [/side]
    [side]
        # extra dwarf boss in the midth
        side=9
        controller=ai
        team_name=enemies
        hidden=yes
        no_leader=yes
        recruit="Dwarvish Masked Steelclad,Dwarvish Masked Stalwart,Dwarvish Masked Thunderguard"
        [unit]
            type=Dwarvish Masked Lord
            generate_name=yes
            side=9
            canrecruit=yes
            placement=leader
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_HEALTHY}
            [/modifications]
        [/unit]
        [ai]
            aggression=1.0
            caution=0.0
        [/ai]
        {GOLD 0 0 0}
        {INCOME -2 -2 -2}
    [/side]

    ###################################################################################################################
    # prestart

    {SETUP_LUA}
    {SAVEFILE_COMPATIBILITY}
    {LUA_SCENARIO 19_Prison.lua}

    [event]
        name=prestart
        {INITIALIZE_CAMPAIGN_VARIABLES}
        {INITIALIZE_SCENARIO_VARIABLES}
        [objectives]
            side=1
            summary=_"Starting Objectives:"
            [objective]
                description=_"Investigate; free your kinsmen!"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Hamel"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Aiglathing"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Elara"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Dulatus"
                condition=lose
            [/objective]
            [gold_carryover]
                bonus=no
                carryover_percentage=100
            [/gold_carryover]
            note=_"The turn limit will technically stay infinite; however, a short time after turn $nWarningTurn your invasion will be noticed, which will mean you'll have to hurry."
        [/objectives]

        [disallow_recruit]
            type=Mage
            side=1
        [/disallow_recruit]

        ################################################################
        # doors
        {PLACE_DOORS 4}

        {PLACE_DOOR 4 sw 11 39 no (role=key_room_door)}
        {PLACE_DOOR 4 sw 12 39 no (role=key_room_door)}
        {PLACE_DOOR 4 sw 13 40 no (role=key_room_door)}
        # wmllint: recognize key_door
        {PLACE_DOOR 4 sw 2 41 yes (id=key_door)}

		# wmlindent: start ignoring
		{PLACE_DOOR 4 se 23 36 yes (
		role=main_track_door
		name=_"heavy gate")}
		{PLACE_DOOR 4 se 24 35 yes (
		role=main_track_door
		name=_"heavy gate")}
		{PLACE_DOOR 4 sw 26 35 yes (
		role=main_track_door
		name=_"heavy gate")}
		{PLACE_DOOR 4 sw 27 36 yes (
		role=main_track_door
		name=_"heavy gate")}

		{PLACE_DOOR 4 sw 15 35 no (
		role=middle_door)}
		{PLACE_DOOR 4 sw 16 35 no (
		role=middle_door)}

		{PLACE_DOOR 4 sw 14 12 no (
		role=throne_room_door)}
		{PLACE_DOOR 4 sw 15 13 no (
		role=throne_room_door)}
		{PLACE_DOOR 4 sw 16 13 no (
		role=throne_room_door)}

		#ids are needed for lua execution code
		# wmllint: recognize northern_magic_gate
		{PLACE_DOOR 4 se 15 9 yes (
		id=northern_magic_gate
		role=magic_gate
		name=_"magic gate")}
		# wmllint: recognize southern_magic_gate
		{PLACE_DOOR 4 se 22 13 yes (
		id=southern_magic_gate
		role=magic_gate
		name=_"magic gate")}
		# wmlindent: stop ignoring

        ################################################################
        # unit handling
#define RANDOM_ENEMY SIDE TYPES X Y
    [set_variable]
        name=random_enemy_type
        rand={TYPES}
    [/set_variable]
    {UNIT {SIDE} $random_enemy_type {X} {Y} (upkeep,ai_special=loyal,guardian)}
    {CLEAR_VARIABLE random_enemy_type}
#enddef

        # own units
#ifdef DEBUG_MODE
        {SORT_UNITS_ARRAY u_Dwarves}
#endif

        # wmllint: recognize Dulatus
        # wmllint: recognize Pelcatlus
        {RECALL_FROM_VARIABLE_ID_X_Y u_Dwarves Dulatus 6 4}
        {RECALL_FROM_VARIABLE_ID_X_Y u_Dwarves Pelcatlus 6 6}
        [if]
            [not]
                [have_unit]
                    id=Pelcatlus
                [/have_unit]
            [/not]
            [then]
                [terrain]
                    x=6
                    y=6
                    terrain=egDC
                [/terrain]
            [/then]
        [/if]
        {RECALL_FROM_VARIABLE_ID_X_Y u_Dwarves Narcatsol 9 4}
        [if]
            [not]
                [have_unit]
                    # wmllint: recognize Narcatsol
                    id=Narcatsol
                [/have_unit]
            [/not]
            [then]
                [terrain]
                    x=9
                    y=4
                    terrain=egDC
                [/terrain]
            [/then]
        [/if]

        [prison_put_prisoners]
            variable=u_Dwarves
            terrain=egDC
        [/prison_put_prisoners]
        [modify_unit]
            [filter]
                side=1
                [not]
                    canrecruit=yes
                    [or]
                        x,y=recall,recall
                    [/or]
                [/not]
            [/filter]
            side=5
        [/modify_unit]
        [remove_shroud]
            side=1
            [filter]
                side=5
            [/filter]
            radius=1
        [/remove_shroud]

        [store_locations]
            variable=locPrisoners
            [filter]
                side=5
            [/filter]
        [/store_locations]
        [sort_array]
            variable=locPrisoners
        [/sort_array]

        [store_locations]
            variable=locCellDoors
            [filter]
                type=Door
            [/filter]
            x=7-15,22-30
            y=5-9,13-17
        [/store_locations]
        [sort_array]
            variable=locCellDoors
        [/sort_array]

        # starting units, the ones from the previous scenario
        # wmllint: recognize Aiglathing
        # wmllint: recognize Elara
        {IFDEF_DEBUG_CREATE_ELARA}
        {RECALL_EVERYONE}

        # the wooden floor middle chambers
        [prison_put_wooden_middlechamber_units]
            variable=u_Dwarves
        [/prison_put_wooden_middlechamber_units]

        # inactive and active own units don't require upkeep
        [store_unit]
            variable=uMakeLoyal
            [filter]
                side=1,5,7
                [not]
                    [filter_wml]
                        upkeep=loyal
                    [/filter_wml]
                [/not]
                [not]
                    canrecruit=yes
                [/not]
            [/filter]
        [/store_unit]
        {FOREACH uMakeLoyal iCurrentUnit}
#ifdef DEBUG_MODE
            [if]
                [lua]
                    code=<<return wesnoth.user_can_invoke_commands>>
                [/lua]
                [then]
                    {DEBUG_MSG "Debug message: making $uMakeLoyal[$iCurrentUnit].name loyal"}
                [/then]
            [/if]
#endif
            {VARIABLE uMakeLoyal[$iCurrentUnit].upkeep loyal}
            {VARIABLE uMakeLoyal[$iCurrentUnit].variables.made_loyal yes}
            [unstore_unit]
                variable=uMakeLoyal[$iCurrentUnit]
            [/unstore_unit]
        {NEXT iCurrentUnit}
        {CLEAR_VARIABLE uMakeLoyal}

        # any remaining own dwarves unstored to the recall list
        {FOREACH u_Dwarves current_dwarf}
            [unstore_unit]
                variable=u_Dwarves[$current_dwarf]
            [/unstore_unit]
        {NEXT current_dwarf}
        # variable clearing in the victory event

        ################################################################
        # enemy units

        {UNIT 3 (Dwarvish Masked Sentinel) 21 37 (upkeep,max_moves,random_traits,generate_name=loyal,0,no,no)}
        [place_room_units]
            side=2
            types=Spectre,Draug,Banebow,Necromancer,Nightgaunt,Ghast
            x_source=17
            y_source=45
            terrain=Iwr
            number=2..3
        [/place_room_units]

        {UNIT 3 (Dwarvish Masked Guardsman) 15 38 (upkeep,max_moves,random_traits,generate_name=loyal,0,no,no)}
        {UNIT 3 (Dwarvish Masked Guardsman) 15 40 (upkeep,max_moves,random_traits,generate_name=loyal,0,no,no)}

        {UNIT 3 (Dwarvish Masked Stalwart) 10 39 (upkeep,role,max_moves,random_traits,generate_name=loyal,key_room_door_guard,0,no,no)}
        {UNIT 3 (Dwarvish Masked Stalwart) 12 40 (upkeep,role,max_moves,random_traits,generate_name=loyal,key_room_door_guard,0,no,no)}

        {UNIT 3 (Dwarvish Masked Stalwart) 5 38 (upkeep,max_moves,random_traits,generate_name=loyal,0,no,no)}
        {UNIT 3 (Dwarvish Masked Stalwart) 5 41 (upkeep,max_moves,random_traits,generate_name=loyal,0,no,no)}
        {UNIT 3 (Dwarvish Masked Steelclad) 9 41 (upkeep,ai_special,generate_name=loyal,guardian,no)}

        {UNIT 3 (Dwarvish Masked Sentinel) 23 34 (upkeep,max_moves,random_traits,role,generate_name=loyal,0,no,heavy_gate_guard,no)}
        {UNIT 3 (Dwarvish Masked Sentinel) 25 33 (upkeep,max_moves,random_traits,role,generate_name=loyal,0,no,heavy_gate_guard,no)}
        {UNIT 3 (Dwarvish Masked Sentinel) 27 34 (upkeep,max_moves,random_traits,role,generate_name=loyal,0,no,heavy_gate_guard,no)}

        [place_room_units]
            side=2
            types=Dark Sorcerer,Necrophage,Wraith,Shadow,Bone Shooter,Chocobone,Deathblade,Revenant,Death Baron
            x_source=17
            y_source=34
            terrain=Iwr
            number=2..5
        [/place_room_units]

        {UNIT 3 (Dwarvish Masked Stalwart) 13 35 (upkeep,max_moves,random_traits,generate_name=loyal,0,no,no)}
        {UNIT 3 (Dwarvish Masked Stalwart) 11 36 (upkeep,max_moves,random_traits,generate_name=loyal,0,no,no)}
        {UNIT 3 (Dwarvish Masked Stalwart) 9 33 (upkeep,max_moves,random_traits,generate_name=loyal,0,no,no)}
        {UNIT 3 (Dwarvish Masked Stalwart) 7 34 (upkeep,max_moves,random_traits,generate_name=loyal,0,no,no)}

        [place_room_units]
            side=2
            types=Dark Sorcerer,Necrophage,Wraith,Shadow,Bone Shooter,Chocobone,Deathblade,Revenant,Death Baron
            x_source=6
            y_source=28
            terrain=Iwr
            number=2..5
        [/place_room_units]

        # dividing path
        [place_room_units]
            side=2
            types=Spectre,Draug,Banebow,Necromancer,Nightgaunt,Ghast
            x_source=14
            y_source=23
            terrain=Iwr
            number=2..3
        [/place_room_units]
        [place_room_units]
            side=2
            types=Dwarvish Masked Lord,Dwarvish Masked Sentinel,Dwarvish Masked Thunderguard
            x_source=6
            y_source=22
            terrain=Iwr
            number=2..3
        [/place_room_units]

        # the small lake
        {UNIT 8 (Cuttle Fish) 9 17 (upkeep,ai_special=loyal,guardian)}
        {UNIT 8 (Sea Serpent) 9 18 (upkeep,ai_special=loyal,guardian)}

        {UNIT 3 (Dwarvish Masked Stalwart) 11 14 (upkeep,max_moves,random_traits,generate_name=loyal,0,no,no)}
        {UNIT 3 (Dwarvish Masked Stalwart) 13 15 (upkeep,max_moves,random_traits,generate_name=loyal,0,no,no)}

        {UNIT 2 (Dwarvish Masked Sentinel) 14 11 (upkeep,max_moves,random_traits,generate_name=loyal,0,no,no)}
        {UNIT 2 (Dwarvish Masked Sentinel) 15 12 (upkeep,max_moves,random_traits,generate_name=loyal,0,no,no)}
        {UNIT 2 (Dwarvish Masked Sentinel) 16 12 (upkeep,max_moves,random_traits,generate_name=loyal,0,no,no)}
        {UNIT 2 (Dwarvish Masked Sentinel) 17 13 (upkeep,max_moves,random_traits,generate_name=loyal,0,no,no)}
        {UNIT 2 (Dwarvish Masked Sentinel) 18 13 (upkeep,max_moves,random_traits,generate_name=loyal,0,no,no)}

        {UNIT 2 (Draug) 18 10 (upkeep,max_moves,random_traits=loyal,0,no)}
        {UNIT 2 (Draug) 19 11 (upkeep,max_moves,random_traits=loyal,0,no)}
        {UNIT 2 (Draug) 20 10 (upkeep,max_moves,random_traits=loyal,0,no)}

        {UNIT 2 (Dwarvish Masked Sentinel) 23 9 (upkeep,max_moves,random_traits,generate_name=loyal,0,no,no)}
        {UNIT 2 (Dwarvish Masked Sentinel) 25 10 (upkeep,max_moves,random_traits,generate_name=loyal,0,no,no)}

        [unit]
            side=6
            type=Death Knight
            x=26
            y=8
            id=executioner
            name=_"Executioner"
            hitpoints=100
            max_hitpoints=100
            [modifications]
                {TRAIT_HEALTHY}
            [/modifications]
        [/unit]

        {RANDOM_ENEMY 2 (Spectre,Draug,Banebow,Necromancer,Nightgaunt,Ghast) 26 5}
        {RANDOM_ENEMY 2 (Spectre,Draug,Banebow,Necromancer,Nightgaunt,Ghast) 31 8}

        [place_room_units]
            side=2
            types=Spectre,Draug,Banebow,Necromancer,Nightgaunt,Ghast
            x_source=28
            y_source=4
            terrain=Iwr
            number=3..5
        [/place_room_units]

        ################################################################
        # items

        # items/enemies in the east
        [set_variable]
            name=enemies_south
            rand=yes,no
        [/set_variable]
#define TEG_PRISON_POTION X Y
    {PICKUPPABLE_ITEM resilience_potion {X} {Y} side=1 items/potion-yellow.png
    _"$unit.name finds a yellow potion. The inscription says: 'potion of resilience'. Shall $unit.name drink it?"
    _"potion of resilience^Take it"
    _"potion of resilience^Leave it"
    () (
        {VARIABLE_DIFFICULTY_DEPENDANT nHPamt 4 3 2}
        [object]
            name=_"potion of resilience"
            image=items/potion-yellow.png
            description=_"This potion increases the consumer's maximum hitpoints by $nHPamt|."
            [effect]
                apply_to=hitpoints
                increase_total=$nHPamt
            [/effect]
        [/object]
        {CLEAR_VARIABLE nHPamt}
        [fire_event]
            name=items_dialog
            [primary_unit]
                id=$unit.id
            [/primary_unit]
        [/fire_event]
    )}
#enddef
        [if]
            [variable]
                name=enemies_south
                equals=yes
            [/variable]
            [then]
                {RANDOM_ENEMY 2 (Spectre,Draug,Banebow,Necromancer) 31 41}
                {RANDOM_ENEMY 2 (Spectre,Draug,Banebow,Necromancer) 33 41}
                {TEG_PRISON_POTION 33 36}
            [/then]
            [else]
                {RANDOM_ENEMY 2 (Spectre,Draug,Banebow,Necromancer) 34 36}
                {RANDOM_ENEMY 2 (Spectre,Draug,Banebow,Necromancer) 33 35}
                {TEG_PRISON_POTION 33 41}
            [/else]
        [/if]
        {CLEAR_VARIABLE enemies_south}
#undef RANDOM_ENEMY
#undef TEG_PRISON_POTION
    [/event]

    # po: bonus in the last northeast chamber:
    {PICKUPPABLE_ITEM intelligence_potion 30 2 side=1 items/potion-blue.png
    _"$unit.name finds a blue potion. The inscription says: 'potion of intelligence'. Shall $unit.name drink it?"
    _"blue potion^Take it"
    _"blue potion^Leave it"
    () (
        [object]
            name=_"potion of intelligence"
            image=items/potion-blue.png
            description=_"This potion decreases the consumer's maximum experience by 5%."
            [effect]
                apply_to=max_experience
                increase=-5%
            [/effect]
        [/object]
    )}

    ########################

    # sacrifice altar
    {PLACE_IMAGE items/altar-evil.png 25 9}

    ########################
    # access to chambers in the east
    {TEG_TOUCHPLATE 21 37 _"Two walls move." (
        {QUAKE rumble.ogg}
        [terrain]
            x= 28, 28
            y= 37, 38
            terrain=Rr
        [/terrain]
        {GIVE_UNIT_EXPERIENCE $unit.id {ON_DIFFICULTY 15 10 5}}
    )}

    ########################
    # some gold in the bottom chamber
    {PLACE_IMAGE items/gold-coins-small.png 14 43}
    [event]
        name=moveto
        [filter]
            side=1
            x,y=14,43
        [/filter]
        {VARIABLE gold_amt {ON_DIFFICULTY 40 30 20}}
        [message]
            speaker=unit
            message=_"There are $gold_amt gold pieces here!"
        [/message]
        [gold]
            side=1
            amount=$gold_amt
        [/gold]
        {CLEAR_VARIABLE gold_amt}
        [sound]
            name=gold.ogg
        [/sound]
        [remove_item]
            x=$x1
            y=$y1
        [/remove_item]
        [fire_event]
            name=items_dialog
            [primary_unit]
                id=$unit.id
            [/primary_unit]
        [/fire_event]
    [/event]

    ########################
    # remove the name of recruited masked dwarves
    [event]
        name=recruit
        first_time_only=no
        [filter]
            type=Dwarvish Masked Fighter,Dwarvish Masked Steelclad,Dwarvish Masked Lord,Dwarvish Masked Thunderer,Dwarvish Masked Thunderguard,Dwarvish Masked Dragonguard,Dwarvish Masked Guardsman,Dwarvish Masked Stalwart,Dwarvish Masked Sentinel
        [/filter]
        {CLEAR_VARIABLE unit.name}
        [unstore_unit]
            variable=unit
        [/unstore_unit]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            [filter_adjacent]
                id=key_door
            [/filter_adjacent]
        [/filter]
        [message]
            speaker=unit
            message=_"This door is closed shut. There appears to be some sort of remote opening mechanism however..."
        [/message]
        [message]
            side=1
            [not]
                id=$unit.id
            [/not]
            message=_"Where is the trigger for that remote mechanism?"
        [/message]
        [message]
            speaker=unit
            # po: We don't know whether prison_guard is alive at this point.
            message=_"Maybe that dwarf boss guards it."
        [/message]
    [/event]
    # po: door to key opens when enemy leader has been killed:
    {TEG_TOUCHPLATE 2 38 _"A door opens." (
        [sound]
            name=open-chest.wav
        [/sound]
        [kill]
            id=key_door
            fire_event=yes
        [/kill]
        {GIVE_UNIT_EXPERIENCE $unit.id {ON_DIFFICULTY 15 10 5}}
    )}
    {PLACE_IMAGE items/key.png 2 42}
#define TAKE_KEY
    [remove_item]
        x,y=$x1,$y1
    [/remove_item]
    [message]
        speaker=unit
        message=_"I've found a key. Maybe when I'm next to some locked door I can open it."
    [/message]
    {VARIABLE unit.role has_key}
    [unstore_unit]
        variable=unit
    [/unstore_unit]
    [unit_overlay]
        id=$unit.id
        image=misc/key.png
    [/unit_overlay]
#enddef
    [event]
        name=moveto
        [filter]
            side=1
            x,y=2,42
        [/filter]
        {TAKE_KEY}
    [/event]
    # just in case the player loses the unit carrying the key
    [event]
        name=die
        first_time_only=no
        [filter]
            role=has_key
        [/filter]
        {PLACE_IMAGE items/key.png $x1 $y1}
        [event]
            name=moveto
            delayed_variable_substitution=no
            [filter]
                side=1
                x,y=$x1,$y1
            [/filter]
            {TAKE_KEY}
        [/event]
    [/event]
#undef TAKE_KEY

    ###################################################################################################################

    {SET_SCENARIO_STATUS_TO (
        [option]
            # po: debug option; completes sentence starting with "Set scenario status to...":
            message=_"killing the first contact dwarf."
            [command]
                [harm_unit]
                    [filter]
                        # wmllint: recognize first_contact
                        id=first_contact
                    [/filter]
                    fire_event=yes
                    kill=yes
                    amount=100
                    animate=yes
                [/harm_unit]
            [/command]
        [/option]
        [option]
            # po: debug option; completes sentence starting with "Set scenario status to...":
            message=_"the dwarf leader being killed."
            [command]
                [kill]
                    side=3
                    canrecruit=yes
                    fire_event=yes
                    animate=yes
                [/kill]
            [/command]
        [/option]
        [option]
            # po: debug option; completes sentence starting with "Set scenario status to...":
            message=_"getting the key."
            [command]
                [kill]
                    side=2,3
                    fire_event=yes
                [/kill]
                [unit]
                    side=1
                    type=Troll
                    x,y=3,39
                    id=prison_troll_to_move
                [/unit]
                [move_unit]
                    id=prison_troll_to_move
                    to_x,to_y=2,38
                    fire_event=yes
                [/move_unit]
                [move_unit]
                    id=prison_troll_to_move
                    to_x,to_y=2,42
                    fire_event=yes
                [/move_unit]
            [/command]
        [/option]
    )}

#ifdef DEBUG_MODE
    [event]
        name=start
        {DEBUG_MSG "Disabling shroud for debug mode..."}
        [modify_side]
            [filter_side]
            [/filter_side]
            shroud=no
            hidden=no
        [/modify_side]
    [/event]
#endif
    ###################################################################################################################

    [event]
        name=start

        [if]
            [not]
                [have_unit]
                    id=Aiglathing
                    x=1-35
                    y=1-45
                [/have_unit]
            [/not]
            [then]
                {TEG_IF_HAVE_RECALL Aiglathing}
            [/then]
        [/if]
        [unit]
            side=3
            type=Dwarvish Masked Fighter
            x,y=12,38
            id=first_contact
            upkeep=loyal
            generate_name=no
        [/unit]
        [move_unit]
            id=first_contact
            to_x=25
            to_y=42
        [/move_unit]

        [message]
            id=first_contact
            # po: speaker = masked dwarf; male:
            message=_"What...? Alarm! There are still dwarves here!"
        [/message]
        [modify_unit]
            [filter]
                side=1
            [/filter]
            facing=nw
        [/modify_unit]
        [message]
            id=Hamel
            message=_"What's this? A dwarf hiding his face? How deep have you fallen to do that? Show us your face and name!"
        [/message]
        [message]
            id=first_contact
            message=_"My... name? ...it does not matter any more..."
        [/message]
        [message]
            id=Aiglathing
            message=_"Where do you come from?"
        [/message]
        [message]
            id=first_contact
            message=_"(<i>keeps quiet</i>)"
        [/message]
        [message]
            id=Hamel
            message=_"Overcome that traitor to loosen his tongue!"
        [/message]
    [/event]

    ###################################################################################################################

    [event]
        name=last breath
        [filter]
            id=first_contact
        [/filter]
        # wmllint: recognize Glamdurus
        {VARIABLE unit.name _"Glamdurus"}
        {VARIABLE unit.type "Dwarvish Fighter"}
        {VARIABLE unit.profile portraits/dwarves/fighter.png}
        [unstore_unit]
            variable=unit
        [/unstore_unit]
        [message]
            speaker=unit
            # po: this is the first masked dwarf's last breath:
            message=_"Ohhh..."
        [/message]
        [message]
            id=Hamel
            message=_"No, that can't be! Glamdurus, I know you, you were one of my bravest fighters..."
        [/message]
        [message]
            speaker=unit
            # po: first masked dwarf's (Glamdurus's) last breath, continued:
            message=_"Thank you for freeing... me..."
        [/message]
        [kill]
            id=$unit.id
            animate=yes
        [/kill]
        [message]
            speaker=second_unit
            # po: this is the unit that killed him speaking:
            message=_"Did you see the poor dwarf's face? What must have been done to him..."
        [/message]
        [message]
            id=Elara
            message=_"It seems that our enemies torture their captives to break their will until they turn against us... I didn't know it was even possible to break a dwarf's will. We must find out whether we can save the remaining ones. We'd better be both quiet and fast."
        [/message]
    [/event]

    ###################################################################################################################
    # move next to heavy gates

    [event]
        name=moveto
        [filter]
            side=1
            [not]
                role=has_key
            [/not]
            [filter_adjacent]
                role=main_track_door
            [/filter_adjacent]
        [/filter]
        [message]
            speaker=unit
            message=_"This gate is firmly closed and looks massive. There is obviously no way for us to cut down this heavy gate, fortified with metal armor. There is a lock on it however."
        [/message]
    [/event]
    [event]
        name=moveto
        [filter]
            role=has_key
            [filter_adjacent]
                role=main_track_door
            [/filter_adjacent]
        [/filter]
        [message]
            speaker=unit
            message=_"Let me see whether I can open the lock on this heavy gate with my key..."
        [/message]
        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message=_"Click!"
        [/message]
        [sound]
            name=correct_sound_effect.wav
        [/sound]
        [kill]
            role=main_track_door
            fire_event=yes
        [/kill]
        {GIVE_UNIT_EXPERIENCE $unit.id {ON_DIFFICULTY 12 8 4}}
    [/event]

    ###################################################################################################################

    [event]
        name=items_dialog
        # TODO: what if unit is Hamel? He ends up talking to himself...
        [message]
            speaker=unit
            # po: "things" = the item being discussed:
            message=_"Why do they let things lie around here?"
        [/message]
        [message]
            id=Hamel
            message=_"They've probably not expected to see us again, and so deep in their territory..."
        [/message]
        {GIVE_UNIT_EXPERIENCE $unit.id {ON_DIFFICULTY 15 10 5}}
    [/event]

    ###################################################################################################################

    [event]
        name=die
        [filter]
            role=key_room_door
        [/filter]
        [remove_shroud]
            side=1
            [filter]
                role=key_room_door_guard
            [/filter]
            radius=1
        [/remove_shroud]
        [message]
            role=key_room_door_guard
            message=_"Alarm! We're being invaded! Call the guards!"
        [/message]
        [modify_side]
            side=3
            {INCOME 10 14 18}
            {GOLD 40 60 80}
        [/modify_side]
    [/event]

    ###################################################################################################################
    [event]
        name=side 6 turn
        first_time_only=no
        [terrain]
            x,y=25,9
            layer=overlay
            terrain="^"
        [/terrain]
        [prison_execute_prisoner]
            execute=$bExecute
        [/prison_execute_prisoner]
        [terrain]
            x,y=25,9
            layer=overlay
            terrain="^Xo"
        [/terrain]
    [/event]
    [event]
        name=lead_away_dialog
        [message]
            speaker=unit
            # po: spoken by the executioner:
            message=_"You there, you come with me!"
        [/message]
        [sound]
            name={SOUND_LIST:DWARF_HIT}
        [/sound]
        [message]
            speaker=second_unit
            # wmllint: local spellings Uff grrr
            # po: spoken by the unit being led away to be executed:
            message=_"Hmpf, no! Uff, no! Hmpf, hmpf, grrr! Blasted pack of bones!"
        [/message]
    [/event]
    [event]
        name=execution_dialog
        [message]
            speaker=unit
            # po: spoken by the executioner:
            message=_"This is your last chance to surrender and join us."
        [/message]
        [sound]
            name={SOUND_LIST:DWARF_HIT}
        [/sound]
        [message]
            speaker=second_unit
            # wmllint: local spelling =*?#~
            # wmlindent: start ignoring
            # The unusual tokens appear to confuse wmlindent.
            # po: spoken by the unit to be executed:
            message=_"%$|%|(=*?#~ !!! (<i>tries to escape</i>) I'd rather die!"
            # wmlindent: stop ignoring
        [/message]
        [message]
            speaker=unit
            # po: spoken by the executioner:
            message=_"So be it."
        [/message]
        [event]
            name=execution_dialog
            [message]
                speaker=unit
                # po: spoken by the executioner:
                message=_"There... I can hear them. They are coming. They are coming to get you. They won't find you, nobody's gonna find you, YOU ARE MINE!"
            [/message]
            [message]
                speaker=second_unit
                # wmlindent: start ignoring
                # po: represents noises made by the unit being executed:
                message=_"%$|%|(=*?#~ !!!"
                # wmlindent: stop ignoring
            [/message]
        [/event]
    [/event]
    [event]
        name=die
        [filter]
            side=5
        [/filter]
        [message]
            id=executioner
            message=_"What a stubborn fool."
        [/message]
    [/event]

    ###################################################################################################################

    [event]
        name=die
        [filter]
            role=wooden_floor_door
        [/filter]
        [remove_shroud]
            side=1
            [filter]
                side=7
            [/filter]
            radius=1
        [/remove_shroud]
        [redraw]
            clear_shroud=yes
        [/redraw]
        [message]
            side=7
            # po: speaker = any side 7 unit; this is after a wooden floor door has just been destroyed:
            message=_"Thanks for freeing me."
        [/message]
        [modify_unit]
            [filter]
                side=7
            [/filter]
            side=1
        [/modify_unit]
    [/event]

    ###################################################################################################################

    [event]
        name=die
        [filter]
            role=middle_door
        [/filter]
        [modify_side]
            side=9
            {INCOME 10 13 16}
            {GOLD 32 36 40}
        [/modify_side]
    [/event]

    ###################################################################################################################

    [event]
        name=die
        [filter]
            type=Sea Serpent
        [/filter]
        [message]
            speaker=second_unit
            # po: "this" = a Sea Serpent:
            message=_"Was this their pet?"
        [/message]
        {GIVE_UNIT_EXPERIENCE $second_unit.id {ON_DIFFICULTY 15 10 5}}
    [/event]

    ###################################################################################################################
    [event]
        name=die
        [filter]
            role=throne_room_door
        [/filter]
        [modify_side]
            side=2
            {INCOME 16 20 24}
            {GOLD 40 60 80}
        [/modify_side]
        [remove_shroud]
            side=1
            [filter]
                id="Ro'Boreth"
            [/filter]
            radius=1
        [/remove_shroud]
        [message]
            # wmllint: deathcheck off
            id="Ro'Boreth"
            # wmllint: deathcheck on
            message=_"What?! We are under attack?"
        [/message]
        [fire_event]
            name=execution_start
        [/fire_event]
    [/event]

    [event]
        name=new turn
        first_time_only=no
        [filter_condition]
            [variable]
                name=turn_number
                numerical_equals= $nWarningTurn
            [/variable]
        [/filter_condition]
        [message]
            id=Hamel
            message=_"We should really make haste now to surprise the prison guards when finally freeing our kinsmen... but due to all this noise which we make..."
        [/message]
    [/event]

#ifdef EASY
    [event]
        name=turn 42 # since this is inside an ifdef, no need to get fancy with math or anything (but, for reference, 42 = 39 + 3)
        [message]
            id=Hamel
            # po: extra warning on EASY difficulty:
            message=_"No, but really, we should hurry... we have no idea what might happen to our imprisoned comrades if we let them stay imprisoned much longer!"
        [/message]
    [/event]
#endif

    [event]
        name=new turn
        first_time_only=no
        [filter_condition]
            [variable]
                name=turn_number
                numerical_equals= $nExecutionStartTurn
            [/variable]
        [/filter_condition]
        [remove_shroud]
            side=1
            [filter]
                id="Ro'Boreth"
            [/filter]
            radius=1
        [/remove_shroud]
        [message]
            id="Ro'Boreth"
            message=_"I think I heard something... I can sense nearby enemies..."
        [/message]
        [message]
            id=Hamel
            message=_"Blast! We must have been too slow, or they noticed all this noise we made..."
        [/message]
        [fire_event]
            name=execution_start
        [/fire_event]
    [/event]

    [event]
        name=execution_start
        {VARIABLE bExecute yes}
        {VARIABLE nExecutionStartTurn -1}
        [message]
            id="Ro'Boreth"
            message=_"Quick! Finish off those dwarves!"
        [/message]
        [remove_shroud]
            side=1
            [filter]
                id=executioner
            [/filter]
            radius=1
        [/remove_shroud]
        [message]
            id=executioner
            message=_"Didn't we want to convert them all?"
        [/message]
        [message]
            id="Ro'Boreth"
            message=_"It was very hard to make the others join our cause, there is no point in continuing. These remaining ones are simply way too stubborn."
        [/message]
        [message]
            id=executioner
            message=_"Well, as you command, then."
        [/message]

        [objectives]
            side=1
            summary=_"Final Objectives:"
            [objective]
                description=_"Save Dulatus from being executed."
                condition=win
            [/objective]
            [objective]
                description=_"Death of Hamel"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Aiglathing"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Elara"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Dulatus"
                condition=lose
            [/objective]
            [gold_carryover]
                bonus=no
                carryover_percentage=100
            [/gold_carryover]
            note=_"The turn limit will technically stay infinite."  + _"
Execution stops only once that the executioner is dead."
        [/objectives]
    [/event]

    ###################################################################################################################

    [event]
        name=die
        [filter]
            id=executioner
        [/filter]
        [fire_event]
            name=execution_end
        [/fire_event]
    [/event]

#ifdef __UNUSED__
    [event]
        name=die
        [filter]
            id="Ro'Boreth"
        [/filter]
        [modify_unit]
            [filter]
                id=executioner
            [/filter]
            side=2
        [/modify_unit]
        [fire_event]
            name=execution_end
        [/fire_event]
    [/event]
#endif

    [event]
        name=execution_end
        {VARIABLE bExecute no}
        [modify_unit]
            [filter]
                side=5
            [/filter]
            side=1
        [/modify_unit]
        [kill]
            role=magic_gate
            fire_event=yes
            animate=yes
        [/kill]
        [message]
            id=Dulatus
            message=_"Thank god you have arrived in time!"
        [/message]
        {TEG_END_SCENARIO_VIA_RIGHTCLICK 100}
    [/event]

    ###################################################################################################################

    [event]
        name=victory

        [role_message]
            type=scout
            else_speaker=Aiglathing
            message=_"We're done here."
        [/role_message]
        [message]
            id=Hamel
            message=_"This was certainly not their main camp, there were too few here... let's hope that the liches capable of creating the portals don't notice we're back too soon..."
        [/message]
        [if]
            [have_unit]
                side=1
                search_recall_list=yes
                x,y=recall,recall
            [/have_unit]
            [then]
                [message]
                    speaker=narrator
                    image=wesnoth-icon.png
                    # po: "They" = the dwarves:
                    message=_"They freed the rest of their kinsmen and turned around back to the main hall."
                [/message]
            [/then]
        [/if]

        ################################################################

        [modify_unit]
            [filter]
                side=5,7
            [/filter]
            side=1
        [/modify_unit]

        # restore the upkeep
        [store_unit]
            variable=uUnmakeLoyal
            [filter]
                side=1
                [filter_wml]
                    [variables]
                        made_loyal=yes
                    [/variables]
                [/filter_wml]
            [/filter]
        [/store_unit]
        {FOREACH uUnmakeLoyal iCurrentLoyal}
            {VARIABLE uUnmakeLoyal[$iCurrentLoyal].upkeep full}
            {CLEAR_VARIABLE uUnmakeLoyal[$iCurrentLoyal].variables.made_loyal}
        {NEXT iCurrentLoyal}
        {CLEAR_VARIABLE uUnmakeLoyal}

        {TEG_UNSTORE_UNITS uMages (recall) (recall)}

        {CLEAR_SCENARIO_VARIABLES}
        {CLEAR_CAMPAIGN_VARIABLES}
    [/event]
    {HERO_DEATHS}
[/scenario]

#undef INITIALIZE_CAMPAIGN_VARIABLES
#undef CLEAR_CAMPAIGN_VARIABLES
#undef INITIALIZE_SCENARIO_VARIABLES
#undef CLEAR_SCENARIO_VARIABLES
